<!DOCTYPE html>
<html lang="fr" class="no-js">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Ansible - Les playbooks</title>

        <!-- Favicon -->
        <link rel="apple-touch-icon" sizes="180x180" href="/rix/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="96x96" href="/rix/favicon-96x96.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/rix/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/rix/favicon-16x16.png">
        <link rel="manifest" href="/rix/site.webmanifest">
                <link rel="shortcut icon" href="/rix/favicon.ico">
        <meta name="msapplication-TileColor" content="#ff4344">
        <meta name="msapplication-config" content="/rix/browserconfig.xml">
        <meta name="theme-color" content="#ffffff">

                        <meta name="description" content="D√©couverte des playbooks, √©l√©ment essentiel d&#039;Ansible qui va nous permettre d&#039;organiser et structurer nos t√¢ches !" />
            <link rel="canonical" href="https://rix-fr.github.io/rix/blog/cours/ansible/ansible-les-playbooks" />

            <!-- Open Graph / Facebook -->
                                        <meta property="og:type" content="website">
                        <meta property="og:title" content="Ansible - Les playbooks" />
            <meta property="og:locale" content="fr" />
            <meta property="og:description" content="D√©couverte des playbooks, √©l√©ment essentiel d&#039;Ansible qui va nous permettre d&#039;organiser et structurer nos t√¢ches !" />
            <meta property="og:url" content="https://rix-fr.github.io/rix/blog/cours/ansible/ansible-les-playbooks" />
            <meta property="og:site_name" content="rix" />

                                        <meta property="og:image" content="https://rix-fr.github.io/rix/resized/content/images/blog/thumbnails/ansible-playbooks.jpg/3835aca3650cfac77042ea0cfa196016.jpg">
                                                    <meta property="og:image:alt" content="Rix - Expertise et outillage DevOps">
            
            <!-- Twitter -->
            <meta property="twitter:card" content="summary_large_image">
            <meta property="twitter:title" content="Ansible - Les playbooks">
            <meta property="twitter:description" content="D√©couverte des playbooks, √©l√©ment essentiel d&#039;Ansible qui va nous permettre d&#039;organiser et structurer nos t√¢ches !">
            <meta property="twitter:site" content="@rix_fr">
            <meta property="twitter:creator" content="@rix_fr">
                                        <meta property="twitter:image" content="https://rix-fr.github.io/rix/resized/content/images/blog/thumbnails/ansible-playbooks.jpg/9a6bfd093813c3412a0c59303420861d.jpg">
                                <script type="application/ld+json">{
    "@context": "https://schema.org",
    "@type": "NewsArticle",
    "headline": "Ansible - Les playbooks",
    "image": [
        "https://rix-fr.github.io/rix/blog/cours/ansible/content/images/blog/thumbnails/ansible-playbooks.jpg"
    ],
    "datePublished": "5 d√©cembre 2023",
    "dateModified": "29 janvier 2024",
    "author": [
        {
            "@type": "Person",
            "name": "Guewen Faivre"
        }
    ],
    "keywords": [
        "Cours",
        "Ansible",
        "Automation",
        "Playbook"
    ]
}
    </script>
            

    <link rel="alternate" type="application/rss+xml" href="/rix/blog/rss.xml" title="Le blog de l'√©quipe Rix" />

                            <meta name="robots" content="noindex" />
        
        <script>
                        document.querySelector('html').classList.remove('no-js');
        </script>

                    <link rel="stylesheet" href="/rix/build/305.b272f288.css">
        
                    <script src="/rix/build/runtime.7013e0e6.js" defer></script><script src="/rix/build/70.671fda9c.js" defer></script><script src="/rix/build/app.e999eb99.js" defer></script>

                        <script defer src="https://comments.rix.fr/comentario.js"></script>
        
    </head>
    <body class="page-article">
                    <header class="header">
                <div class="container">
                    <a href="/rix/">
                        <img src="/rix/build/images/logos/logo-horizontal.ae7b8485.svg" alt="" class="logo">
                        <span class="screen-reader">Retour √† l'accueil</span>
                    </a>

                                            <nav class="nav">
    <ul>
                                    <li class="nav__item ">
                    <a href="/rix/">
                        <span>Accueil</span>
                    </a>
                </li>
                                                <li class="nav__item ">
                    <a href="/rix/services">
                        <span>Nos services</span>
                    </a>
                </li>
                                                <li class="nav__item ">
                    <a href="/rix/etudes-de-cas">
                        <span>Cas clients</span>
                    </a>
                </li>
                                                <li class="nav__item ">
                    <a href="/rix/a-propos">
                        <span>√Ä propos</span>
                    </a>
                </li>
                                                <li class="nav__item ">
                    <a href="/rix/blog">
                        <span>Blog</span>
                    </a>
                </li>
                            <li class="nav__item nav__item--icon">
            <a href="/rix/contact">
                <svg viewBox="0 0 20 17" fill="none" class="contact-icon">
    <path d="M18.7692 12.4368H16.343V15L12.3512 12.4368H1V1H18.7692V12.4368Z" stroke="#99b7d1" stroke-width="2" fill="none"/>
    <g>
        <circle cx="5.84621" cy="6.92311" r="1.07692" fill="#eb5050"/>
        <circle cx="10.1538" cy="6.92311" r="1.07692" fill="#eb5050"/>
        <circle cx="14.4614" cy="6.92311" r="1.07692" fill="#eb5050"/>
    </g>
</svg>

                <span>Contactez-nous</span>
            </a>
        </li>
    </ul>
</nav>

                    
                                            <nav class="nav-mobile">
    <div class="nav-mobile__header">
        <a href="/rix/">
            <img src="/rix/build/images/logos/logo-horizontal-white.901392b9.svg" alt="" class="logo">
        </a>
        <button class="nav-toggle nav-toggle--close">
            <i class="icon icon--close" aria-hidden="true"></i>
            <span class="screen-reader">Fermer le menu</span>
        </button>
    </div>
    <ul>
                                    <li class="nav-mobile__item  ">
                    <a href="/rix/">
                        Accueil
                    </a>
                </li>
                                                <li class="nav-mobile__item  ">
                    <a href="/rix/services">
                        Nos services
                    </a>
                </li>
                                                <li class="nav-mobile__item  ">
                    <a href="/rix/etudes-de-cas">
                        Cas clients
                    </a>
                </li>
                                                <li class="nav-mobile__item  ">
                    <a href="/rix/a-propos">
                        √Ä propos
                    </a>
                </li>
                                                <li class="nav-mobile__item  ">
                    <a href="/rix/blog">
                        Blog
                    </a>
                </li>
                            <li class="nav-mobile__item nav-mobile__item--icon">
            <a href="/rix/contact">
                <svg viewBox="0 0 20 17" fill="none" class="contact-icon">
    <path d="M18.7692 12.4368H16.343V15L12.3512 12.4368H1V1H18.7692V12.4368Z" stroke="#99b7d1" stroke-width="2" fill="none"/>
    <g>
        <circle cx="5.84621" cy="6.92311" r="1.07692" fill="#eb5050"/>
        <circle cx="10.1538" cy="6.92311" r="1.07692" fill="#eb5050"/>
        <circle cx="14.4614" cy="6.92311" r="1.07692" fill="#eb5050"/>
    </g>
</svg>

                Contactez-nous
            </a>
        </li>
    </ul>
</nav>
<button class="nav-toggle nav-toggle--open">
    <i class="icon icon--hamburger" aria-hidden="true"></i>
    <span class="screen-reader">Ouvrir le menu</span>
</button>

                                    </div>
            </header>
                <main>
                <div class="banner banner--blog">
        <div class="container">
            <h1>
                <a href="/rix/blog">Blog</a>
                <strong>/</strong>
            </h1>
        </div>
    </div>

    <div class="beveled-wrapper">
        <div class="beveled-wrapper__gradient">
            <div class="container shape"><!-- üê∫ shape --></div>
            <div class="container content">
                <ul class="tags-list">
                                            <li class="tags-list__item">
                            #Cours
                        </li>
                                            <li class="tags-list__item">
                            #Ansible
                        </li>
                                            <li class="tags-list__item">
                            #Automation
                        </li>
                                            <li class="tags-list__item">
                            #Playbook
                        </li>
                                    </ul>
                <h2 class="h2--large">Ansible - Les playbooks</h2>
                <p>D√©couverte des playbooks, √©l√©ment essentiel d&#039;Ansible qui va nous permettre d&#039;organiser et structurer nos t√¢ches !</p>
                <div class="article-overview">
                                        <ol class="table-of-contents">
                                                            <li class="table-of-contents__item">
                                    <a href="#preambule">Pr√©ambule</a>
                                                                    </li>
                                                            <li class="table-of-contents__item">
                                    <a href="#pre-requis">Pr√©-requis</a>
                                                                    </li>
                                                            <li class="table-of-contents__item">
                                    <a href="#introduction">Introduction</a>
                                                                    </li>
                                                            <li class="table-of-contents__item">
                                    <a href="#les-playbooks">Les playbooks</a>
                                                                            <ol class="table-of-contents__sub-level">
                                                                                            <li>
                                                    <a href="#structure-generale-d-un-playbook">Structure g√©n√©rale d&#039;un playbook</a>
                                                </li>
                                                                                            <li>
                                                    <a href="#la-commande-ansible-playbook">La commande ansible-playbook</a>
                                                </li>
                                                                                            <li>
                                                    <a href="#les-notions-de-play-et-de-tasks">Les notions de ¬´ play ¬ª et de ¬´ tasks ¬ª</a>
                                                </li>
                                                                                            <li>
                                                    <a href="#visualiser-les-machines-ciblees">Visualiser les machines cibl√©es</a>
                                                </li>
                                                                                    </ol>
                                                                    </li>
                                                            <li class="table-of-contents__item">
                                    <a href="#les-taches">Les t√¢ches</a>
                                                                            <ol class="table-of-contents__sub-level">
                                                                                            <li>
                                                    <a href="#l-escalade-de-privileges">L&#039;escalade de privil√®ges</a>
                                                </li>
                                                                                            <li>
                                                    <a href="#organiser-ses-taches">Organiser ses t√¢ches</a>
                                                </li>
                                                                                            <li>
                                                    <a href="#taguer-ses-taches">Taguer ses t√¢ches</a>
                                                </li>
                                                                                    </ol>
                                                                    </li>
                                                            <li class="table-of-contents__item">
                                    <a href="#point-de-progression">Point de progression</a>
                                                                    </li>
                                                            <li class="table-of-contents__item">
                                    <a href="#aller-plus-loin-avec-les-sources">Aller plus loin avec les sources</a>
                                                                    </li>
                                                    </ol>
                                        <div class="article-info">
                                                                            <div class="author ">
                                <div class="author__image">
                                                                            <img     src="/rix/resized/content/images/member/avatars/gfaivre.jpg/b9e2ad5ccb2390253e2c23ccbfb41dc7.jpg"
    srcset="
        /rix/resized/content/images/member/avatars/gfaivre.jpg/b9e2ad5ccb2390253e2c23ccbfb41dc7.jpg 1x,
        /rix/resized/content/images/member/avatars/gfaivre.jpg/d2d8af0b210c37c677635983f1c02d6d.jpg 2x
    "
 />
                                                                    </div>
                                <span class="author__info">
                                    √âcrit par
                                                                            <strong>Guewen Faivre</strong>
                                                                    </span>
                            </div>
                                                <div class="article-info__date">
                            <span>Publication <strong>5 d√©cembre 2023</strong></span>
                                                                                        <span>Modification <strong>29 janvier 2024</strong></span>
                                                    </div>
                    </div>
                </div>
                <main>
                                                            <body><h2 id="preambule" class="anchor-title"><a href="#preambule">Pr√©ambule</a></h2>
<p>Ce cours est utilis√© dans le cadre de TP au sein de l'IUT Lyon 1. Il est notamment dispens√© √† des √©tudiants peu ou pas familiers avec les strat√©gies d'automatisation et de d√©ploiement des infrastructures.
Bien que tr√®s ax√© d√©butants il peut √©galement repr√©sent√© une possibilit√© de monter ¬´ rapidement ¬ª pour certaines √©quipes sur les principes fondamentaux d'Ansible afin de disposer du bagage minimal n√©cessaire √† son utilisation.</p>
<p>Il s'agit bien √©videmment de supports √† vocation p√©dagogique qui <strong>ne sont pas toujours transposables</strong> √† une activit√© professionnelle.</p>
<h2 id="pre-requis" class="anchor-title"><a href="#pre-requis">Pr√©-requis</a></h2>
<p>Disposer d'un <strong>environnement de travail Ansible fonctionnel</strong>, si √ßa n'est pas encore le cas vous pouvez jeter un oeil <a href="/blog/cours/ansible/ansible-premiers-pas">ici</a> !</p>
<h2 id="introduction" class="anchor-title"><a href="#introduction">Introduction</a></h2>
<p>Un playbook est un √©l√©ment <strong>central</strong> pour Ansible puisque c'est dans ce fichier de configuration (√©crit en YAML toujours), que l'on va organiser et indiquer quelles actions nous souhaitons d√©clencher. </p>
<p>Les playbooks d√©crivent des ¬´ t√¢ches ¬ª √† ex√©cuter sur des groupes de machines identifi√©s dans <a href="/blog/cours/ansible/ansible-les-inventaires-statiques">les inventaires</a>, ils sont √©crits √† l'aide du format <a href="https://yaml.org/" target="_blank">YAML</a>.</p>
<div class="admonition info">
<p class="admonition-title">La syntaxe Yaml</p>
<p>
    Yaml est un langage ou plut√¥t un format, qui permet de s√©rialiser des donn√©es afin qu'elles restent lisiblent pour nous. Les donn√©es sont organis√©es sous la forme de paire cl√©/valeur dans des listes ordonn√©es, il est de plus en plus utilis√© notamment pour les fichiers de configuration.
</p>
</div>
<h2 id="les-playbooks" class="anchor-title"><a href="#les-playbooks">Les playbooks</a></h2>
<p>Afin de rentrer dans le vif du sujet nous allons √©crire un playbook relativement simple utilisant un module que nous avons vu pr√©c√©demment, le module <strong>ping</strong>. Nous avons vu que les modules Ansible peuvent √™tre utilis√©s en ligne de commande pour ex√©cuter une <strong>t√¢che ponctuelle</strong> mais rappelons que le but d'Ansible est en premier lieu, d'<strong>automatiser</strong> les choses et donc de les rendre <strong>r√©utilisables</strong> !</p>
<h3 id="structure-generale-d-un-playbook" class="anchor-title"><a href="#structure-generale-d-un-playbook">Structure g√©n√©rale d'un playbook</a></h3>
<p>Cr√©ons un nouveau fichier que nous appellerons <code class="code-inline" id="c91a24a63d659cd3b2cf6f2e04b303a5">example.yml</code> dans notre r√©pertoire de travail (pour rappel de mon c√¥t√© <code class="code-inline" id="2f56b2c4e169e525b08cdbdbfc1a4543">workspace/ansible</code>) contenant:</p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="6b99c3ab65a642c622b8d12636402450"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> web

  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Check if host is alive <span class="token comment"># Description of the task</span>
      <span class="token key atrule">ansible.builtin.ping</span><span class="token punctuation">:</span> <span class="token null important">~</span></code></pre>
<p>La structure YAML permet une compr√©hension relativement ais√©e du contenu, on identifiera ainsi:</p>
<ul>
<li>Une cl√© principale appel√©e <code class="code-inline" id="85cf4e6d42a71e693fd780c8b29accdd">hosts</code> permettant de d√©finir les ¬´ h√¥tes ¬ª, les machines concern√©es par les t√¢ches qui vont suivre (identifi√©es par leur groupe d'appartenance);</li>
<li>Une cl√© <code class="code-inline" id="2cb1ad4f3eb0ea704c74a73689ad1654">tasks</code> permettant de d√©finir les diff√©rentes ¬´ t√¢ches ¬ª ou actions que nous souhaitons d√©clencher sur nos machines.</li>
</ul>
<p><strong>Un bloc ainsi d√©fini est appel√© un ¬´ play ¬ª</strong>.</p>
<div class="admonition info">
<p class="admonition-title">---</p>
<p>
    Vous l'aurez not√©, les playbooks que nous r√©digeons commencent tous avec trois tirets <code class="code-inline" id="9efc314b65237d5d646e1b817372afc6">---</code>, ceux-ci marquent en effet en syntaxe Yaml, le d√©but du document, ils sont donc indispensables √† l'interpr√©tation du fichier.
    Ils permettent entre autres d'utiliser des directives en ent√™tes de fichier ou de disposer de plusieurs flux yaml dans un m√™me fichier (le d√©but de chaque flux √©tant indiqu√© par ces trois tirets).
</p>
</div>
<p>Rappelez-vous nous pouvons traduire les instructions suivantes sous forme de <strong>tableaux</strong>:</p>
<pre class="code-multiline language-php"><code class="language-php" id="3aa09a0370641167cb45d3aebf7d15b9"><span class="token keyword">array</span> <span class="token punctuation">(</span>
    <span class="token string single-quoted-string">'hosts'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'web'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'tasks'</span> <span class="token operator">=&gt;</span> 
        <span class="token keyword">array</span> <span class="token punctuation">(</span>
            <span class="token number">0</span> <span class="token operator">=&gt;</span> 
                <span class="token keyword">array</span> <span class="token punctuation">(</span>
                    <span class="token string single-quoted-string">'name'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'Check if host is alive'</span><span class="token punctuation">,</span>
                    <span class="token string single-quoted-string">'ansible.builtin.ping'</span> <span class="token operator">=&gt;</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span></code></pre>
<p>On constate encore plus ais√©ment sous cette forme que la cl√© <code class="code-inline" id="2cb1ad4f3eb0ea704c74a73689ad1654">tasks</code> permet de d√©finir un nombre ind√©fini de ¬´ t√¢ches ¬ª √† ex√©cuter, celles-ci ayant toujours au moins pour structure:</p>
<ul>
<li>Un nom (cl√© <code class="code-inline" id="b068931cc450442b63f5b3d276ea4297">name</code>);</li>
<li>L'appel √† un module ansible (ici nous faisons appel au module <code class="code-inline" id="df911f0151f9ef021d410b4be5060972">ping</code> utilis√© pr√©c√©demment) chaque module acceptant ou non des param√®tres.</li>
</ul>
<div class="admonition info">
<p class="admonition-title">Les modules Ansible</p>
<p>
    Un module pour Ansible est un composant logiciel qui encapsule une t√¢che sp√©cifique.
    Pour r√©sumer, il s'agit d'un <strong>bloc de code</strong> qui est ex√©cut√© par Ansible pour accomplir une <strong>action donn√©e</strong> sur un <strong>syst√®me cible</strong>. On trouve notamment des modules capables de <strong>g√©rer des fichiers</strong>, d'<strong>ex√©cuter des commandes</strong> ou encore de <strong>g√©rer des services</strong>.
    Ils peuvent √™tre √©crits dans divers langages de programmation, mais la plupart sont √©crits en <strong>Python</strong>. Ansible vient avec une large gamme de modules int√©gr√©s pour g√©rer diff√©rents aspects des syst√®mes, des applications et des infrastructures.
</p>
</div>
<h3 id="la-commande-ansible-playbook" class="anchor-title"><a href="#la-commande-ansible-playbook">La commande ansible-playbook</a></h3>
<p>Nous avons d√©j√† vu les commandes <code class="code-inline" id="640c8a5376aa12fa15cf02130ce239a6">ansible</code> et <code class="code-inline" id="c849dabdafeab0ab6aae256ec60514b7">ansible-inventory</code> au tour de <code class="code-inline" id="6afa1ad605a4192ba2e50e8be9966e68">ansible-playbook</code></p>
<p>En ex√©cutant cette commande <code class="code-inline" id="b98b55aaa24c708c6a23328d5166e6fb">ansible-playbook example.yml -i inventories</code> vous devriez obtenir la sortie suivante ou √©quivalente (si tout se passe bien).</p>
<figure>
    <img src="/rix/resized/content/images/blog/2023/ansible/ansible-playbook/ansible-playbook-example.png/60539304d17a65d7f89b5eb88cea3749.png" srcset="/rix/resized/content/images/blog/2023/ansible/ansible-playbook/ansible-playbook-example.png/60539304d17a65d7f89b5eb88cea3749.png 1x,
/rix/resized/content/images/blog/2023/ansible/ansible-playbook/ansible-playbook-example.png/cca60d1a0018444ee0fdca536c154d58.png 2x," id="60539304d17a65d7f89b5eb88cea3749-png">
    <figcaption>
      <span class="figure__legend">Utilisation du module ping dans un playbook.</span>
    </figcaption>
</figure>
<p>Nous venons donc de faire appel au module ping mais <strong>√† l'int√©rieur d'un playbook</strong>. Ce que nous avons en retour et une sortie type d'Ansible sur laquelle on peut remarquer quelques informations toujours int√©ressantes (tout en bas) avec notamment:</p>
<ul>
<li><code class="code-inline" id="444bcb3a3fcf8389296c49467f27e1d6">ok</code>: Le nombre de t√¢ches (tasks) qui se sont correctement ex√©cut√©es;</li>
<li><code class="code-inline" id="8977dfac2f8e04cb96e66882235f5aba">changed</code>: Le nombre de changements op√©r√©s sur nos machines cibles;</li>
<li><code class="code-inline" id="b748f56cf76526f8606d7463b9df9f2e">unreachable</code>: Le nombre de machines injoignables (par soucis de r√©seau par exemple);</li>
<li><code class="code-inline" id="26934eb377001f66e37289a5c93fe284">failed</code>: Le nombre de t√¢ches en erreur;</li>
<li><code class="code-inline" id="e52e279299e912838f689d4380c81f4a">skipped</code>: Le nombre de t√¢ches qui ont √©t√© ignor√©es (par exemple si une t√¢ches ne remplie pas certaines conditions pr√©d√©finies).</li>
</ul>
<h3 id="les-notions-de-play-et-de-tasks" class="anchor-title"><a href="#les-notions-de-play-et-de-tasks">Les notions de ¬´ play ¬ª et de ¬´ tasks ¬ª</a></h3>
<p>Il est bon de not√© √©galement qu'un playbook peut contenir plusieurs ¬´ plays ¬ª nous pouvons donc avoir des t√¢ches attribu√©es √† diff√©rents groupes cible comme ceci: </p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="5b79aab6622202710027e4488e48b287"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> webservers

  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Check if host is alive <span class="token comment"># Description of the task</span>
      <span class="token key atrule">ansible.builtin.ping</span><span class="token punctuation">:</span>

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> dbservers

  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Get stats of a file
      <span class="token key atrule">ansible.builtin.stat</span><span class="token punctuation">:</span>
        <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/hosts</code></pre>
<figure>
    <img src="/rix/resized/content/images/blog/2023/ansible/ansible-playbook/ansible-playbook-groups.jpg/c27db12c82517f971ecdbd3d010185db.jpg" srcset="/rix/resized/content/images/blog/2023/ansible/ansible-playbook/ansible-playbook-groups.jpg/c27db12c82517f971ecdbd3d010185db.jpg 1x,
/rix/resized/content/images/blog/2023/ansible/ansible-playbook/ansible-playbook-groups.jpg/1322e1e27cdb4902c08f0bc366de6f39.jpg 2x," id="c27db12c82517f971ecdbd3d010185db-jpg">
    <figcaption>
      <span class="figure__legend">Playbook contenant deux ¬´ plays ¬ª.</span>
    </figcaption>
</figure>
<p>Nous avons dans ce cas de figure deux groupes chacun concern√© par une ¬´ t√¢che ¬ª:</p>
<ul>
<li>Le groupe <code class="code-inline" id="09c2ea6bb9250e08e7dd4d3e48358c1c">webservers</code> (contenant donc 2 machines) sur lequel nous ex√©cutons le module ping;</li>
<li>Le groupe <code class="code-inline" id="98b017f5726ac5cc1d0f3ebc0d5e9932">dbservers</code> (contenant √©galement 2 machines) sur lequel nous ex√©cutons le module <code class="code-inline" id="77ddcb5f19832f4145345889013ab3a4">stat</code>.</li>
</ul>
<div class="admonition info">
<p class="admonition-title">Le module stat</p>
<p>
    Le module stat permet d'ex√©cuter la commande syst√®me <code class="code-inline" id="77ddcb5f19832f4145345889013ab3a4">stat</code> sur un fichier du serveur cible. Il prends diff√©rents param√®tres que l'on peut retrouver sur la <a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/stat_module.html" target="_blank">documentation officielle</a> dont le param√®tre <code class="code-inline" id="d6fe1d0be6347b8ef2427fa629c04485">path</code> qui lui est obligatoire.
</p>
</div>
<p>Rappelez-vous √©galement qu'un ¬´ play ¬ª peut ex√©cuter plusieurs t√¢ches les unes √† la suite des autres, exemple: </p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="a40d59f9942710ae8eb0e397f445dcde"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> webservers

  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Check if host is alive <span class="token comment"># Description of the task</span>
      <span class="token key atrule">ansible.builtin.ping</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Execute a simple command
      <span class="token key atrule">ansible.builtin.shell</span><span class="token punctuation">:</span> echo "Ansible was here <span class="token tag">!</span>" <span class="token punctuation">&gt;</span> ansible.txt

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> dbservers

  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Get stats of a file
      <span class="token key atrule">ansible.builtin.stat</span><span class="token punctuation">:</span>
        <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/hosts</code></pre>
<p>Vous devriez, en jouant votre playbook (<code class="code-inline" id="b98b55aaa24c708c6a23328d5166e6fb">ansible-playbook example.yml -i inventories</code>) obtenir une sortie √©quivalente √†:</p>
<figure>
    <img src="/rix/resized/content/images/blog/2023/ansible/ansible-playbook/ansible-playbook-tasks.jpg/eb4c8f6e6951132cc85983159479ceae.jpg" srcset="/rix/resized/content/images/blog/2023/ansible/ansible-playbook/ansible-playbook-tasks.jpg/eb4c8f6e6951132cc85983159479ceae.jpg 1x,
/rix/resized/content/images/blog/2023/ansible/ansible-playbook/ansible-playbook-tasks.jpg/3d3e1ff571b62722a02ea21e52fce83f.jpg 2x," id="eb4c8f6e6951132cc85983159479ceae-jpg">
    <figcaption>
      <span class="figure__legend">Playbook contenant deux ¬´ plays ¬ª et plusieurs ¬´ tasks ¬ª.</span>
    </figcaption>
</figure>
<p>√Ä la diff√©rence de nos premi√®res t√¢ches, l'utilisation du module <code class="code-inline" id="2591c98b70119fe624898b1e424b5e91">shell</code> a entrain√© une modification de l'√©tat des deux serveurs membres du groupe <code class="code-inline" id="09c2ea6bb9250e08e7dd4d3e48358c1c">webservers</code> qu'Ansible nous confirme √† l'aide de son retour <code class="code-inline" id="8977dfac2f8e04cb96e66882235f5aba">changed</code>.</p>
<h3 id="visualiser-les-machines-ciblees" class="anchor-title"><a href="#visualiser-les-machines-ciblees">Visualiser les machines cibl√©es</a></h3>
<p>Lorsque l'on dispose de playbook assez longs, il peut-√™tre int√©ressant de v√©rifier la liste des h√¥tes concern√©s, c'est faisable √† l'aide de la commande <code class="code-inline" id="21030b1bc68fb02a94414f4458e99f08">ansible-playbook example.yml -i inventories --list-host</code>.</p>
<figure>
    <img src="/rix/resized/content/images/blog/2023/ansible/ansible-playbook/ansible-playbook-list-host.gif/3380753e5b694ee86c4d72d157c09c79.gif" id="3380753e5b694ee86c4d72d157c09c79-gif">
    <figcaption>
      <span class="figure__legend">Lister les h√¥tes concern√©s par un playbook.</span>
    </figcaption>
</figure>
<p>Il est √©galement possible de lister les t√¢ches avec l'option <code class="code-inline" id="1b8bb051252fed496fb13ca0bbc3458c">--list-tasks</code> et bien √©videmment de combiner ces deux options <code class="code-inline" id="3979d0f30abe7ac0334e4dde9a637a2a">ansible-playbook example.yml -i inventories --list-tasks --list-hosts</code>.</p>
<figure>
    <img src="/rix/resized/content/images/blog/2023/ansible/ansible-playbook/ansible-playbook-list-tasks-hosts.jpg/ae35ec8bc8245ce7cada9bd81e7ff6c5.jpg" srcset="/rix/resized/content/images/blog/2023/ansible/ansible-playbook/ansible-playbook-list-tasks-hosts.jpg/ae35ec8bc8245ce7cada9bd81e7ff6c5.jpg 1x,
/rix/resized/content/images/blog/2023/ansible/ansible-playbook/ansible-playbook-list-tasks-hosts.jpg/cb2200015ba23ffc86168edb3bcadaf0.jpg 2x," id="ae35ec8bc8245ce7cada9bd81e7ff6c5-jpg">
    <figcaption>
      <span class="figure__legend">Lister les h√¥tes et les t√¢ches concern√©s par un playbook.</span>
    </figcaption>
</figure>
<p>Vous aurez √©galement remarqu√© la pr√©sence d'une information <code class="code-inline" id="c90ec9d6825f9d9ee5bfffec58a8052f">[TAGS]</code> tr√®s utile dont nous parlerons par la suite ;)</p>
<h2 id="les-taches" class="anchor-title"><a href="#les-taches">Les t√¢ches</a></h2>
<p>Nous avons vu les principes fondamentaux du fonctionnement des ¬´ tasks ¬ª avec Ansible, mais celles-ci peuvent √™tre <strong>plus complexes</strong> que celles que nous avons pu voir jusqu'√† pr√©sent.
Afin de s'en rendre compte nous allons <strong>d√©ployer un serveur web Nginx</strong> sur nos instances web.</p>
<p>Nous allons ajouter une t√¢che d√©di√©e dans un nouveau playbook que nous appelerons <code class="code-inline" id="35e10f4319de8bbbbd2033b3448a5e5d">webservers.yml</code> et qui contiendra les instructions suivantes:</p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="6022b4e7cd7f523552ed96153e3391c4"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> webservers

  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install Nginx web server
      <span class="token key atrule">ansible.builtin.apt</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">update_cache</span><span class="token punctuation">:</span> yes
        <span class="token key atrule">state</span><span class="token punctuation">:</span> present</code></pre>
<p>En l'ex√©cutant (<code class="code-inline" id="b9aecf7ac1e3a8f356a240bd742c1c9a">ansible-playbook webservers.yml -i inventories</code>) vous devriez obtenir la sortie ci-dessous, Ansible nous indiquant qu'il a effectu√© une modification sur nos machines distantes:</p>
<figure>
    <img src="/rix/resized/content/images/blog/2023/ansible/ansible-playbook/ansible-playbook-apt.jpg/61297f50c3f81b91155f26fcf12b639e.jpg" srcset="/rix/resized/content/images/blog/2023/ansible/ansible-playbook/ansible-playbook-apt.jpg/61297f50c3f81b91155f26fcf12b639e.jpg 1x,
/rix/resized/content/images/blog/2023/ansible/ansible-playbook/ansible-playbook-apt.jpg/60652788f5851e9cafba97c9469e7b37.jpg 2x," id="61297f50c3f81b91155f26fcf12b639e-jpg">
    <figcaption>
      <span class="figure__legend">Installation d'Nginx avec Ansible.</span>
    </figcaption>
</figure>
<p>On notera l'utilisation du module <code class="code-inline" id="583f72a833c7dfd63c03edba3776247a">apt</code> (attention, utilisable bien √©videmment uniquement avec les distributions <strong>bas√©es sur Debian</strong>) accompagn√© de plusieurs param√®tres;</p>
<ul>
<li><code class="code-inline" id="b068931cc450442b63f5b3d276ea4297">name</code>: le nom du paquet √† installer</li>
<li><code class="code-inline" id="d289e44b689800170b69ff7fabfbe7e9">update_cache</code>: Indique qu'il faut effectuer une mise √† jour de l'index des paquets avant l'installation.</li>
<li><code class="code-inline" id="9ed39e2ea931586b6a985a6942ef573e">state</code>: ¬´ L'√©tat ¬ª dans lequel nous souhaitons avoir le paquet install√© (present, absent, latest...)</li>
</ul>
<p>Vous devriez √©galement pouvoir interroger votre serveur web en utilisant l'IP de votre machine <code class="code-inline" id="78de6a9fb573e10f121995b4b497db15">http://XXX.XXX.XXX.XXX</code>.</p>
<h3 id="l-escalade-de-privileges" class="anchor-title"><a href="#l-escalade-de-privileges">L'escalade de privil√®ges</a></h3>
<p>Avec cette t√¢che d'installation nous touchons une autre probl√©matique qui est celle de la <strong>gestion des droits</strong> et notamment la modification de mani√®re globale de l'√©tat d'un syst√®me, ce qui rel√®ve normalement de la comp√©tence du compte <code class="code-inline" id="63a9f0ea7bb98050796b649e85481845">root</code>, super administrateur des syst√®mes √† base UNIX.</p>
<p>Si nous n'avons pas rencontr√© de probl√®me jusqu'√† pr√©sent c'est parce que nous utilisons un <a href="/blog/cours/ansible/ansible-environnement-cle-en-main">lazy Ansible</a> pr√©-configur√© avec certaines directives dans le <strong>fichier de configuration d'Ansible</strong> dont nous reparlerons un peu plus tard.</p>
<p>Il est toutefois possible le cas √©ch√©ant, d'indiquer au niveau d'une t√¢che que celle-ci r√©clame des droits d'administrateur et qu'il faut d√©clencher une escalade de privil√®ges. Cela se fait en utilisant des cl√©s r√©serv√©es comme ci-dessous (en reprenant la t√¢che d'installation Nginx):</p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="d8897529f49527dc58e7bd09f8c78b5b"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> webservers
  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> debian

  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Ensure Nginx service is started
      <span class="token key atrule">service</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">state</span><span class="token punctuation">:</span> started
      <span class="token key atrule">become</span><span class="token punctuation">:</span> yes
      <span class="token key atrule">become_user</span><span class="token punctuation">:</span> root <span class="token comment"># This is the default value, so it's not mandatory here</span></code></pre>
<p><strong>On remarquera les cl√©s:</strong></p>
<ul>
<li><code class="code-inline" id="b15438ecfab2d31dfa016635e69725e3">remote_user</code>: Pr√©cisant l'utilisateur avec lequel se connecter √† la machine;</li>
<li><code class="code-inline" id="86280ac8a7f8881407ba060c76d72d6a">become</code>: Indiquant s'il faut d√©clencher une escalade de privil√®ges;</li>
<li><code class="code-inline" id="57b4e5fb0d1fa785cfae5ced33c090fc">become_user</code>: Indiquant le nom du compte utilisateur vers lequel faire l'escalade (Par d√©faut <strong>root</strong>).</li>
</ul>
<p>Le m√©canisme utilis√© par Ansible pour faire son escalade est par d√©faut la commande <code class="code-inline" id="d338b3f0f405eb5e51c8cc1e5ca66f02">sudo</code>, il est possible de modifier ce comportement avec la cl√© <code class="code-inline" id="804ccea6cdb445fed6a184db60245f84">become_method</code>.</p>
<h3 id="organiser-ses-taches" class="anchor-title"><a href="#organiser-ses-taches">Organiser ses t√¢ches</a></h3>
<p>Nous avons vu que chaque ¬´ play ¬ª peut contenir <strong>plusieurs t√¢ches</strong>, il faut savoir que celles-ci sont ex√©cut√©es dans l'ordre dans lequel elles apparaissent et sur l'ensemble des machines qui correspondent √† leur domaine d'application (un <strong>groupe</strong> ou une <strong>machine</strong>).
Le but de chacune de ces t√¢ches est d'ex√©cuter un module (nous en avons d√©j√† vu plusieurs, <strong>ping</strong>, <strong>stat</strong>, <strong>apt</strong>, <strong>shell</strong>), chaque module se devant d'√™tre <a href="https://fr.wikipedia.org/wiki/Idempotence" target="_blank">idempotent</a> garantissant ainsi que peu importe le nombre de fois ou il sera ex√©cut√© il produira toujours le m√™me r√©sultat si ses param√®tres d'entr√©e demeurent inchang√©s.</p>
<p>Il est important que chaque t√¢che dispose d'une cl√© <code class="code-inline" id="b068931cc450442b63f5b3d276ea4297">name</code> fournissant des instructions claires sur son r√¥le (<strong>pensez √† la maintenance</strong>).</p>
<p>Ceci-dit il est bon de savoir que nos t√¢ches peuvent √™tre organis√©es de diff√©rentes mani√®res et notamment en utilisant les diff√©rentes sections que l'on peut trouver dans un playbook:</p>
<ul>
<li><code class="code-inline" id="c14192fc9675e5023582b237e885e10d">pre_tasks</code>: Contient les t√¢ches √† ex√©cuter en premier;</li>
<li><code class="code-inline" id="4295e8065f2f640103f566df3329e17f">roles</code>: Indiquant une liste de r√¥les √† utiliser dans notre ¬´ play ¬ª (Nous verrons cette notion plus tard);</li>
<li><code class="code-inline" id="122262e3bc2b18846d6367493be122dc">post_tasks</code>: Contenant les t√¢ches √† ex√©cuter en dernier;</li>
<li><code class="code-inline" id="7c0b3e6cb1f202796bb60528e017a994">handlers</code>: Contenant des t√¢ches d√©clench√©es √† la fin de chaque bloc ou section de t√¢ches <strong>en fonction de certains √©v√®nements</strong>.</li>
</ul>
<h4 id="la-section-pre-tasks" class="anchor-title"><a href="#la-section-pre-tasks">La section pre_tasks</a></h4>
<p>Elle correspond √† une ex√©cution conditionnelle d'un bloc de code <strong>AVANT</strong> de lancer le ¬´ play ¬ª, elle peut √™tre charg√©e soit de v√©rifier des pr√©-requis soit de valider un √©tat.</p>
<p>Souvenez-vous au moment d'installer notre paquet Nginx nous avions ajout√© le param√®tre <code class="code-inline" id="d289e44b689800170b69ff7fabfbe7e9">update_cache</code> afin de mettre √† jour l'index des paquets. Mais nous avons une autre option qui se pr√©sente, plut√¥t que de faire figurer cette option sur chaque appel au module <code class="code-inline" id="583f72a833c7dfd63c03edba3776247a">apt</code> que nous aurons dans notre playbook, nous pouvons g√©rer la mise √† jour de l'index des paquets avant de le jouer.</p>
<p><strong>Modifions notre playbook <code class="code-inline" id="35e10f4319de8bbbbd2033b3448a5e5d">webservers.yml</code> de la fa√ßon suivante:</strong></p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="a5912311a42dab0b6d7f25302c5709a1"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> webservers

  <span class="token key atrule">pre_tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Updating APT cache index
      <span class="token key atrule">ansible.builtin.apt</span><span class="token punctuation">:</span>
        <span class="token key atrule">update_cache</span><span class="token punctuation">:</span> yes

  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install Nginx web server
      <span class="token key atrule">ansible.builtin.apt</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">state</span><span class="token punctuation">:</span> present</code></pre>
<p>Et ex√©cutons le, nous devrions obtenir la sortie suivante: </p>
<figure>
    <img src="/rix/resized/content/images/blog/2023/ansible/ansible-playbook/ansible-playbook-pre-tasks.jpg/4c55a2c80172722cb00c2699a96f791e.jpg" srcset="/rix/resized/content/images/blog/2023/ansible/ansible-playbook/ansible-playbook-pre-tasks.jpg/4c55a2c80172722cb00c2699a96f791e.jpg 1x,
/rix/resized/content/images/blog/2023/ansible/ansible-playbook/ansible-playbook-pre-tasks.jpg/709fe795189f9280d551c12204c0a274.jpg 2x," id="4c55a2c80172722cb00c2699a96f791e-jpg">
    <figcaption>
      <span class="figure__legend">Ex√©cution d'une pre-task.</span>
    </figcaption>
</figure>
<p>O√π l'on constate qu'effectivement la premi√®re t√¢che ex√©cut√©e est notre mise √† jour d'index de paquets (nous parlerons plus en d√©tails de la t√¢che ¬´ <a href="/blog/cours/ansible/ansible-les-variables/"><strong>Gathering facts</strong></a> ¬ª lorsque nous aborderons les <strong>variables</strong>)</p>
<p>Nous ne d√©taillerons pas la section <code class="code-inline" id="122262e3bc2b18846d6367493be122dc">post_tasks</code> puisqu'elle fonctionne exactement de la m√™me mani√®re, toutefois nous pouvons <strong>enrichir notre playbook</strong> avec de nouvelles instructions concernant nos instances de bases de donn√©es.</p>
<p><strong>Pour cela nous avons plusieurs options:</strong></p>
<ul>
<li>Soit tout concentrer dans notre playbook <code class="code-inline" id="35e10f4319de8bbbbd2033b3448a5e5d">webservers.yml</code>, mais l'on pourra faire remarquer √† raison, que le nom du fichier n'est plus en ad√©quation avec son contenu;</li>
<li>Soit cr√©er un nouveau playbook d√©di√© aux instances de bases de donn√©es <code class="code-inline" id="5e770988217638696ce7e93a56c3da3d">dbservers.yml</code>.</li>
</ul>
<p>Nous nous orienterons pour l'exemple, sur cette seconde option, nous cr√©erons donc un fichier <code class="code-inline" id="5e770988217638696ce7e93a56c3da3d">dbservers.yml</code> √† la racine de notre r√©pertoire de travail dont le contenu ressemblera beaucoup √† celui de <code class="code-inline" id="35e10f4319de8bbbbd2033b3448a5e5d">webservers.yml</code>.</p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="a0409a75a354f079b77aeb45a0f55314"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> dbservers

  <span class="token key atrule">pre_tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Updating APT cache index
      <span class="token key atrule">ansible.builtin.apt</span><span class="token punctuation">:</span>
        <span class="token key atrule">update_cache</span><span class="token punctuation">:</span> yes

  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token comment"># MARIADB</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install MariaDB server
      <span class="token key atrule">ansible.builtin.apt</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> mariadb<span class="token punctuation">-</span>server
        <span class="token key atrule">state</span><span class="token punctuation">:</span> present</code></pre>
<p>Notre nouveau playbook est bien evidemment ¬´ jouable ¬ª √† l'aide de la commande <code class="code-inline" id="8ee9161eaa245fd21d6887f8a5e0cd4b">ansible-playbook dbservers.yml -i inventories</code>.</p>
<h4 id="les-handlers" class="anchor-title"><a href="#les-handlers">Les handlers</a></h4>
<p>Bien, reprenons notre exemple d'installation d'Nginx, nous avons un paquet ¬´ tout neuf ¬ª auquel nous n'avons apport√© aucune configuration pour l'instant.
Imaginons √† pr√©sent que nous souhaitions ajouter un fichier de configuration sp√©cifique pour notre serveur web, pour notre exemple nous mettrons en place un fichier qui nous renvoie simplement un ¬´ √©tat ¬ª de notre serveur Nginx.</p>
<p>En premier lieu nous allons cr√©er un nouveau <strong>r√©pertoire</strong> appel√© <code class="code-inline" id="45b963397aa40d4a0063e0d85e4fe7a1">files</code> √† la racine de notre espace de travail lui m√™me contenant un <strong>r√©pertoire</strong> <code class="code-inline" id="ee434023cf89d7dfb21f63d64f0f9d74">nginx</code> (histoire d'organiser un minimum les choses) dans lequel nous ajouterons le fichier <code class="code-inline" id="617f940792257db3b58a57be6b4a6c50">status.conf</code> contenant:</p>
<pre class="code-multiline"><code id="18dd76eb1056156c3ae8407bc53c292f">server {
    listen *:8080;
    root /usr/share/nginx/html;
    access_log off;
    location / {
        return 404;
    }
    location = /nginx/status {
        stub_status on;
    }
}</code></pre>
<p>Modifions √† pr√©sent notre fichier <code class="code-inline" id="35e10f4319de8bbbbd2033b3448a5e5d">webservers.yml</code> de la fa√ßon suivante:</p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="e8cf5ddc1b5eb7ed95e1f85201e285c6"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> webservers

  <span class="token key atrule">pre_tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Updating APT cache index
      <span class="token key atrule">ansible.builtin.apt</span><span class="token punctuation">:</span>
        <span class="token key atrule">update_cache</span><span class="token punctuation">:</span> yes

  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install Nginx web server
      <span class="token key atrule">ansible.builtin.apt</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">state</span><span class="token punctuation">:</span> present
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Nginx status configuration file
      <span class="token key atrule">ansible.builtin.copy</span><span class="token punctuation">:</span>
        <span class="token key atrule">src</span><span class="token punctuation">:</span> nginx/status.conf
        <span class="token key atrule">dest</span><span class="token punctuation">:</span> /etc/nginx/conf.d/status.conf</code></pre>
<p>Si tout s'est d√©roul√© correctement vous devriez avoir un fichier <code class="code-inline" id="617f940792257db3b58a57be6b4a6c50">status.conf</code> nouvellement cr√©√© par Ansible sur vos machines cibles dans le r√©pertoire <code class="code-inline" id="c93438a126d84a32cb4712c215498037">/etc/nginx/conf.d/</code>.
Pour terminer nous pouvons v√©rifier que notre configuration fonctionne bien en interrogeant l'adresse: <a href="http://XXX.XXX.XXX.XXX:8080/nginx/status" target="_blank"><strong>http://XXX.XXX.XXX.XXX:8080/nginx/status</strong></a>... <strong>ou pas</strong> !</p>
<div class="admonition info">
<p class="admonition-title">Le module copy</p>
<p>
    Le module <code class="code-inline" id="12cba3ee81cf4a793796a51b6327c678">copy</code> permet de g√©rer les fichiers de nos machines cibles √† savoir leur cr√©ation, leur suppression mais √©galement leur type (n'oubliez pas, sur des syst√®mes UNIX tout est fichier !). Il permet notamment de transf√©rer des fichiers de configuration vers des machines. Par d√©faut √† son utilisation Ansible recherche le fichier pass√© en param√®tre dans le r√©pertoire <code class="code-inline" id="45b963397aa40d4a0063e0d85e4fe7a1">files</code> de l'espace de travail.
</p>
</div>
<p>En l'√©tat actuel vous devriez avoir pour toute r√©ponse une <strong>page blanche</strong>, en effet bien que notre fichier de configuration ait √©t√© d√©pos√© sur le serveur, Nginx ne le prend pas encore en compte car le service n'a pas √©t√© <strong>red√©marr√©</strong>.
C'est l√† qu'entre en jeu <strong>les handlers</strong> !</p>
<p>Les handlers sont des t√¢ches un peu particuli√®res qui ne se d√©clenchent que lorsqu'elles sont <strong>notifi√©es</strong>.
Compl√©tons notre playbook de mani√®re √† obtenir la configuration suivante:</p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="3b435d5d82d9102136cae515e9999b93"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> webservers

  <span class="token key atrule">pre_tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Updating APT cache index
      <span class="token key atrule">ansible.builtin.apt</span><span class="token punctuation">:</span>
        <span class="token key atrule">update_cache</span><span class="token punctuation">:</span> yes

  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install Nginx web server
      <span class="token key atrule">ansible.builtin.apt</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">state</span><span class="token punctuation">:</span> present
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Nginx status configuration file
      <span class="token key atrule">ansible.builtin.copy</span><span class="token punctuation">:</span>
        <span class="token key atrule">src</span><span class="token punctuation">:</span> nginx/status.conf
        <span class="token key atrule">dest</span><span class="token punctuation">:</span> /etc/nginx/conf.d/status.conf
      <span class="token key atrule">notify</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> restart_nginx

  <span class="token key atrule">handlers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> restart_nginx
      <span class="token key atrule">ansible.builtin.service</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">state</span><span class="token punctuation">:</span> restarted</code></pre>
<p>En rejouant notre playbook <code class="code-inline" id="b9aecf7ac1e3a8f356a240bd742c1c9a">ansible-playbook webservers.yml -i inventories</code> nous constons que cela n'a rien chang√© ! Effectivement, comme dit pr√©c√©demment un handler r√©agit √† un <strong>√©v√®nement</strong>, dans notre cas √† la modification du fichier <code class="code-inline" id="617f940792257db3b58a57be6b4a6c50">status.conf</code>. Comme nous ne l'avons pas modifi√© le handler n'a pas √©t√© notifi√©.</p>
<p>En introduisant une modification dans notre fichier (par exemple en modifiant la directive <code class="code-inline" id="47f52dedc48034d27b096c159a6dc021">access_log</code> pour la passer √† off) nous devrions enfin pouvoir acc√©der √† notre page de statut √† l'adresse: <a href="http://XXX.XXX.XXX.XXX:8080/nginx/status" target="_blank"><strong>http://XXX.XXX.XXX.XXX:8080/nginx/status</strong></a>.</p>
<p>Vous devriez √©galement pouvoir constater l'ex√©cution du handler sur la sortie Ansible:</p>
<figure>
    <img src="/rix/resized/content/images/blog/2023/ansible/ansible-playbook/ansible-playbook-handler.jpg/dc709322f2276448cacc708dcd0218fc.jpg" srcset="/rix/resized/content/images/blog/2023/ansible/ansible-playbook/ansible-playbook-handler.jpg/dc709322f2276448cacc708dcd0218fc.jpg 1x,
/rix/resized/content/images/blog/2023/ansible/ansible-playbook/ansible-playbook-handler.jpg/6eb1cc47a7c80cb64d8a1ad991701ef4.jpg 2x," id="dc709322f2276448cacc708dcd0218fc-jpg">
    <figcaption>
      <span class="figure__legend">Ex√©cution d'un handler.</span>
    </figcaption>
</figure>
<div class="admonition info">
<p class="admonition-title">La directive ¬´ Notify ¬ª</p>
<p>
    Les actions de type <code class="code-inline" id="a4510384236c8e83a0cf3b6d8b987aef">notify</code> sont d√©clench√©es <strong>√† la fin de chaque bloc de t√¢ches</strong> d'un ¬´ play ¬ª donn√©, elles ne le sont bien √©videmment <strong>qu'une seule fois</strong> m√™me si elles sont appel√©e plusieurs fois.
</p>
</div>
<p>Il est √©galement possible d'ajouter √† un handler une cl√© <code class="code-inline" id="839d7228b5ccc60e54455093a966b8c2">listen</code> comme ci-dessous, celle-ci indiquant au handler ¬´ d'√©couter ¬ª un th√®me sp√©cifique permettant de regrouper plusieurs ¬´ handlers ¬ª.</p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="3760a33542300664ae88814a2662ba2f"><span class="token key atrule">handlers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> restart_nginx
      <span class="token key atrule">ansible.builtin.service</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">state</span><span class="token punctuation">:</span> restarted
    <span class="token key atrule">listen</span><span class="token punctuation">:</span> restart_http_stack

    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> restart haproxy
      <span class="token key atrule">ansible.builtin.service</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> haproxy
        <span class="token key atrule">state</span><span class="token punctuation">:</span> restarted
    <span class="token key atrule">listen</span><span class="token punctuation">:</span> restart_http_stack</code></pre>
<h4 id="les-instructions-import-et-export" class="anchor-title"><a href="#les-instructions-import-et-export">Les instructions import... et export...</a></h4>
<p>Vous l'aurez compris, si l'on conserve l'ensemble de nos instructions dans un seul playbook celui-ci peut rapidemnent devenir <strong>volumineux et difficile</strong> √† maintenir. Pour autant s√©parer nos instructions dans des playbooks d√©di√©s conduit invariablement √† dupliquer certains blocs d'instructions ce qui n'est pas non plus l'id√©al, fort heureusement il est possible de r√©soudre ces probl√©matiques de mani√®re √©l√©gante en utilisant diff√©rentes instructions pr√©fix√©es <code class="code-inline" id="fe8630d1d657e9bb58b1a9260acd93cf">import_</code> et <code class="code-inline" id="0583300c259450db57fd2307fc84a673">export_</code>.</p>
<p><strong>Avant de r√©organiser nos travaux il est important de bien comprendre la diff√©rence entre les deux:</strong></p>
<ul>
<li>Les instructions de type <code class="code-inline" id="9ec8c49bdcba93e76013a10e3b107b76">import_*</code> sont ¬´ pr√©-trait√©es ¬ª au moment o√π les playbooks sont parcourus et donc avant leur ex√©cution;</li>
<li>Les instructions de type <code class="code-inline" id="36d2653a72f06c6cd8c23ef246e0f785">export_*</code> sont trait√©es au moment o√π elles sont rencontr√©es durant l'ex√©cution. </li>
</ul>
<p><strong>R√©organisons √† pr√©sent nos playbooks en tenant compte de cette nouvelle information:</strong></p>
<ul>
<li>L'instruction de mise √† jour de notre index APT dans notre <code class="code-inline" id="c14192fc9675e5023582b237e885e10d">pre_tasks</code> peut-√™tre consid√©r√©e comme <strong>une t√¢che commune</strong> √† l'ensemble des machines;</li>
<li>Il est int√©ressant de pouvoir ¬´ jouer ¬ª de mani√®re ind√©pendante les deux playbooks <code class="code-inline" id="35e10f4319de8bbbbd2033b3448a5e5d">webservers.yml</code> et <code class="code-inline" id="5e770988217638696ce7e93a56c3da3d">dbservers.yml</code> mais il peut aussi √™tre ¬´ sympa ¬ª de pouvoir <strong>les appeler de mani√®re group√©e</strong>;</li>
<li>Les handlers pourront √™tre potentiellement notifi√©s de mani√®re transverse par de futures t√¢ches de configuration.</li>
</ul>
<p>Nous d√©placerons donc nos t√¢ches ¬´ communes ¬ª dans un playbook d√©di√© <code class="code-inline" id="bc4930c33479e166f682f0031e513be6">common.yml</code> qui contiendra donc:</p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="16ef5ddfb32998c9ae2976567b572137"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Updating APT cache index
  <span class="token key atrule">ansible.builtin.apt</span><span class="token punctuation">:</span>
    <span class="token key atrule">update_cache</span><span class="token punctuation">:</span> yes</code></pre>
<p>Nous supprimerons bien √©videmment des playbooks <code class="code-inline" id="35e10f4319de8bbbbd2033b3448a5e5d">webservers.yml</code> et <code class="code-inline" id="5e770988217638696ce7e93a56c3da3d">dbservers.yml</code> les instructions correspondantes.</p>
<p>Nos handlers eux, finiront dans un nouveau playbook <code class="code-inline" id="7f3b19104652c4e477b43b3f04ce0ac2">handlers.yml</code> comme ci-dessous:</p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="b7da470b61009f1817239f1c1a38a4a8"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> restart_nginx
  <span class="token key atrule">ansible.builtin.service</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">state</span><span class="token punctuation">:</span> restarted
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> restart_mariadb
  <span class="token key atrule">ansible.builtin.service</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> mariadb
    <span class="token key atrule">state</span><span class="token punctuation">:</span> restarted</code></pre>
<p>Quant √† nos deux playbooks principaux nous les modifierons l√©g√®rement en y ajoutant:</p>
<ul>
<li>l'inclusion des pre_tasks (<code class="code-inline" id="bc4930c33479e166f682f0031e513be6">common.yml</code>);</li>
<li>l'inclusion des handlers (<code class="code-inline" id="7f3b19104652c4e477b43b3f04ce0ac2">handlers.yml</code>);</li>
<li>un playbook ¬´ global ¬ª afin de les d√©clencher.</li>
</ul>
<p><strong>Respectivement:</strong></p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="4aea649df32b90aec788ad030b05d5df"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> webservers

  <span class="token key atrule">pre_tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">ansible.builtin.import_tasks</span><span class="token punctuation">:</span> common.yml

  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token comment"># NGINX</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install Nginx web server
      <span class="token key atrule">ansible.builtin.apt</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">state</span><span class="token punctuation">:</span> present

    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Nginx status configuration file
      <span class="token key atrule">ansible.builtin.copy</span><span class="token punctuation">:</span>
        <span class="token key atrule">src</span><span class="token punctuation">:</span> nginx/status.conf
        <span class="token key atrule">dest</span><span class="token punctuation">:</span> /etc/nginx/conf.d/status.conf
      <span class="token key atrule">notify</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> restart_nginx

  <span class="token key atrule">handlers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">ansible.builtin.include_tasks</span><span class="token punctuation">:</span> handlers.yml</code></pre>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="ef1e538bc89419ac3a3be89e118f443c"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> dbservers

  <span class="token key atrule">pre_tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">ansible.builtin.import_tasks</span><span class="token punctuation">:</span> common.yml

  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token comment"># NGINX</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install MariaDB server
      <span class="token key atrule">ansible.builtin.apt</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> mariadb<span class="token punctuation">-</span>server
        <span class="token key atrule">state</span><span class="token punctuation">:</span> present

  <span class="token key atrule">handlers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">ansible.builtin.include_tasks</span><span class="token punctuation">:</span> handlers.yml</code></pre>
<p>Nous cr√©erons enfin pour terminer un dernier playbook <code class="code-inline" id="c0c84c46776cbacdea8e3ecb98f3dd65">main.yml</code> contenant:</p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="95e8e7ff0d30ec6b7d97b785902b9f74"><span class="token punctuation">-</span> <span class="token key atrule">ansible.builtin.import_playbook</span><span class="token punctuation">:</span> webservers.yml
<span class="token punctuation">-</span> <span class="token key atrule">ansible.builtin.import_playbook</span><span class="token punctuation">:</span> dbservers.yml</code></pre>
<p>Nous pouvons √† pr√©sent jouer l'ensemble avec la commande: <code class="code-inline" id="8c7354e1cff57ed36e4431314a54e660">ansible-playbook main.yml -i inventories</code> !</p>
<p>Tout semble fonctionner ! Mais est-ce vraiment le cas ?
Modifiez √† nouveau le fichier de configuration <code class="code-inline" id="617f940792257db3b58a57be6b4a6c50">status.conf</code> destin√© √† Nginx et relancer le provisionning.</p>
<p>Vous devriez vous retrouver avec l'erreur <code class="code-inline" id="f40ea55e1ea4604069bc09b42697416a">ERROR! The requested handler 'restart_nginx' was not found in either the main handlers list nor in the listening handlers list</code> ! </p>
<p>En effet nous avons utilis√© une directive de type <code class="code-inline" id="d436eb0fd9de10b54a828ce6435f7e81">include</code> pour inclure notre fichier de handlers, or nous avons vu que ces instructions ne sont pas ¬´ pr√©-trait√©es ¬ª. Ansible lorsqu'il parcours notre playbook rencontre donc l'instruction:</p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="32921237cf69dc04426071b8c0b9b9a4"><span class="token key atrule">notify</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> restart_nginx</code></pre>
<p>AVANT que notre fichier <code class="code-inline" id="7f3b19104652c4e477b43b3f04ce0ac2">handlers.yml</code> et donc qu'Ansible ait connaissance de l'existance de ce handler !</p>
<p>Pour corriger ce comportement il faudra donc dans notre cas utiliser la directive:</p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="a529dd7a521de3e9c5d35a954983c539"><span class="token key atrule">handlers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">ansible.builtin.inport_tasks</span><span class="token punctuation">:</span> handlers.yml</code></pre>
<h3 id="taguer-ses-taches" class="anchor-title"><a href="#taguer-ses-taches">Taguer ses t√¢ches</a></h3>
<p>Nous venons de voir la possibilit√© de ¬´ diviser pour r√©organiser ¬ª nos t√¢ches, mais il existe √©galement la possibilit√© de ¬´ taguer ¬ª nos t√¢ches de mani√®re √† les d√©clencher de mani√®re <strong>cibl√©e</strong>, ouvrant √©galement la possibilit√© de les ex√©cuter de fa√ßons transverses si celles-ci appartiennent √† plusieurs playbooks diff√©rents. </p>
<p>Nous verrons qu'ils sont <strong>tr√®s utiles voir indispensables</strong> d√®s lorsque nous aurons abord√© la notion de <strong>roles</strong>.</p>
<p>Reprenons notre exemple pr√©c√©dent o√π nous disposons de deux playbooks principaux distincts <code class="code-inline" id="35e10f4319de8bbbbd2033b3448a5e5d">webservers.yml</code> et <code class="code-inline" id="5e770988217638696ce7e93a56c3da3d">dbservers.yml</code> nous les modifierons de fa√ßon √† ¬´ taguer ¬ª nos diff√©rentes t√¢ches comme ci-apr√®s:</p>
<p><strong>Webservers:</strong></p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="0b9737c6b7d556f948304ab150fd8466"><span class="token punctuation">...</span>
  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token comment"># NGINX</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install Nginx web server
      <span class="token key atrule">ansible.builtin.apt</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">state</span><span class="token punctuation">:</span> present
      <span class="token key atrule">tags</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> nginx
        <span class="token punctuation">-</span> installation

    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Nginx status configuration file
      <span class="token key atrule">ansible.builtin.copy</span><span class="token punctuation">:</span>
        <span class="token key atrule">src</span><span class="token punctuation">:</span> nginx/status.conf
        <span class="token key atrule">dest</span><span class="token punctuation">:</span> /etc/nginx/conf.d/status.conf
      <span class="token key atrule">notify</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> restart_nginx
      <span class="token key atrule">tags</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> nginx
        <span class="token punctuation">-</span> configuration
<span class="token punctuation">...</span></code></pre>
<p><strong>Dbservers:</strong></p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="019e5d9c0d3097a39636bca37f409f1d"><span class="token punctuation">...</span>
  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token comment"># NGINX</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install MariaDB server
      <span class="token key atrule">ansible.builtin.apt</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> mariadb<span class="token punctuation">-</span>server
        <span class="token key atrule">state</span><span class="token punctuation">:</span> present
      <span class="token key atrule">tags</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> db
<span class="token punctuation">...</span></code></pre>
<h4 id="utilisation" class="anchor-title"><a href="#utilisation">Utilisation</a></h4>
<p>Maintenant que nos tags sont d√©finis nous sommes en capacit√© de les exploiter en ajoutant l'option <code class="code-inline" id="6f25395e79fac881defa876bd79e9ecc">--tags</code> √† notre ex√©cution ce qui nous donnera par exemple: </p>
<ul>
<li><code class="code-inline" id="f4344daabf6a7425a8632af0a14d201d">ansible-playbook main.yml -i inventories --tags "nginx,db"</code>.</li>
</ul>
<p>Il est √©galement possible d'ignorer certains tags avec l'option <code class="code-inline" id="62fd855941ceb308c49c4a562310a43b">--skip-tags</code>: </p>
<ul>
<li><code class="code-inline" id="9c7ee4964f76d37bbfc11296975e05c6">ansible-playbook main.yml -i inventories --skip-tags db</code>.</li>
</ul>
<h4 id="les-tags-never-and-always" class="anchor-title"><a href="#les-tags-never-and-always">Les tags never and always</a></h4>
<p>Ansible dans son fonctionnement, pr√©voit <strong>des tags r√©serv√©s</strong>:</p>
<ul>
<li><code class="code-inline" id="f9f90eeaf400d228facde6bc48da5cfb">always</code>, permet de syst√©matiquement jouer une t√¢che <strong>sauf</strong> lorsqu'elle est explicitement exclue √† l'aide de l'option <code class="code-inline" id="62fd855941ceb308c49c4a562310a43b">--skip-tags</code>;</li>
<li><code class="code-inline" id="c7561db7a418dd39b2201dfe110ab4a4">never</code> √† l'inverse, permettra de ne <strong>jamais jouer les t√¢ches concern√©es √† moins de le sp√©cifier explicitement</strong> √† l'aide le l'option <code class="code-inline" id="6f25395e79fac881defa876bd79e9ecc">--tags</code>.</li>
</ul>
<div class="admonition info">
<p class="admonition-title">La t√¢che ¬´ Gathering facts ¬ª</p>
<p>
    La t√¢che ¬´ Gathering fact ¬ª porte le tag ¬´ always ¬ª par d√©faut qui lui permet d'√™tre jou√©e syst√©matiquement, il est donc possible d'ignorer cette t√¢che via les options vues ci-dessus. Toutefois son absence peut entrainer un mauvais fonctionnement (voir une erreur) des diff√©rentes t√¢ches devant √™tre ex√©cut√©es √† sa suite.
</p>
</div>
<h2 id="point-de-progression" class="anchor-title"><a href="#point-de-progression">Point de progression</a></h2>
<p><strong>Nous savons √† pr√©sent g√©rer:</strong></p>
<ul>
<li>L'installation d'un <a href="/blog/cours/ansible/ansible-environnement-cle-en-main">environnement Ansible</a>;</li>
<li>Utiliser l'<a href="/blog/cours/ansible/ansible-les-inventaires-statiques">inventaire</a>;</li>
<li>Cr√©er des playbooks.</li>
</ul>
<p>Nous pouvons toutefois encore apporter un peu de <strong>dynamisme</strong> √† ces premi√®res notions par l'introduction de <a href="/blog/cours/ansible/ansible-les-variables">variables</a> dont nous parlerons dans la suite.</p>
<h2 id="aller-plus-loin-avec-les-sources" class="anchor-title"><a href="#aller-plus-loin-avec-les-sources">Aller plus loin avec les sources</a></h2>
<ul>
<li><a href="https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_intro.html" target="_blank">https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_intro.html</a></li>
<li><a href="https://docs.ansible.com/ansible/2.9/modules/list_of_all_modules.html" target="_blank">https://docs.ansible.com/ansible/2.9/modules/list_of_all_modules.html</a></li>
<li><a href="https://yaml.org/spec/1.2.2/#912-document-markers" target="_blank">https://yaml.org/spec/1.2.2/#912-document-markers</a></li>
<li><a href="https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_privilege_escalation.html" target="_blank">https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_privilege_escalation.html</a></li>
<li><a href="https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_handlers.html#handlers" target="_blank">https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_handlers.html#handlers</a></li>
<li><a href="https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_tags.html" target="_blank">https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_tags.html</a></li>
</ul></body>
                                                                                </main>
                <div class="article-footer" data-aos="fade-in">
                                                                        <div class="author">
                                <div class="author__image">
                                    <img     src="/rix/resized/content/images/member/avatars/gfaivre.jpg/b9e2ad5ccb2390253e2c23ccbfb41dc7.jpg"
    srcset="
        /rix/resized/content/images/member/avatars/gfaivre.jpg/b9e2ad5ccb2390253e2c23ccbfb41dc7.jpg 1x,
        /rix/resized/content/images/member/avatars/gfaivre.jpg/d2d8af0b210c37c677635983f1c02d6d.jpg 2x
    "
 />
                                </div>
                                <span class="author__info">
                                    √âcrit par
                                    <strong>Guewen Faivre</strong>
                                </span>
                                <div class="author__social">
                                                                            <a href="https://twitter.com/guewen_faivre">
                                            <i class="icon icon--twitter" aria-hidden="true"></i>
                                            <span class="screen-reader">Compte twitter de Guewen Faivre</span>
                                        </a>
                                                                                                                <a href="https://github.com/gfaivre">
                                            <i class="icon icon--github" aria-hidden="true"></i>
                                            <span class="screen-reader">Compte github de Guewen Faivre</span>
                                        </a>
                                                                                                                <a href="http://www.elao.com">
                                            <i class="icon icon--website" aria-hidden="true"></i>
                                            <span class="screen-reader">Site personnel de Guewen Faivre</span>
                                        </a>
                                                                    </div>
                            </div>
                                                            </div>
                                    <div class="comment">
                                                    <div id="comentario"></div>
                                                                                                    <p>
                                Une typo ?
                                <a href="https://github.com/rix-fr/rix/edit/main/content/blog/cours/ansible/ansible-les-playbooks.md/" target="_blank">Modifier cet article sur Github</a>
                            </p>
                                            </div>
                            </div>
        </div>
    </div>
        </main>
                    <footer class="footer">
    <div class="container">
        <div class="footer__contact">
            <div class="catchphrase">
                <p class="h1">Le monde du DevOps vous semble obscur ?</p>
                <p>Contactez-nous, nous vous aiderons √† y <strong>voir plus clair</strong>.</p>
            </div>
            <div class="contact-tiles">
                <span class="contact-tiles__item">
                    <i class="icon icon--location" aria-hidden="true"></i>
                    <span>
                        <span class="title">Passez nous voir !</span>
                        <span>Nous sommes √† Lyon !</span>
                        <span>34 rue Jean Broquin</span>
                        <span>69006 Lyon, France</span>
                    </span>
                </span>
                <span class="contact-tiles__item">
                    <i class="icon icon--message" aria-hidden="true"></i>
                    <span>
                        <span class="title">Par t√©l√©phone ou par mail</span>
                        <a href="tel:33482537609">04 82 53 76 09</a>
                        <a href="mailto:contact@rix.fr">contact@rix.fr</a>
                    </span>
                </span>
            </div>
        </div>
        <div class="footer__brand">
            <img src="/rix/build/images/logos/logo-horizontal-white.901392b9.svg" alt="Rix">
            <span>Expertise et outilllage DevOps</span>
        </div>
        <nav class="footer__links">
            <div class="pages">
                <ul>
                                                                        <li>
                                <a href="/rix/etudes-de-cas">Cas clients</a>
                            </li>
                                                                                                <li>
                                <a href="/rix/a-propos">√Ä propos</a>
                            </li>
                                                                                                <li>
                                <a href="/rix/contact">Contact</a>
                            </li>
                                                            </ul>
            </div>
            <div class="services">
                <a href="/rix/services">Nos services</a>
                <div>
                                            <ul>
                                                            <li>
                                    <a href="/rix/services#accompagnement_outillage">Accompagnement et outillage DevOps</a>
                                </li>
                                                            <li>
                                    <a href="/rix/services#experts_kubernetes">Expertise Kubernetes</a>
                                </li>
                                                            <li>
                                    <a href="/rix/services#performances_diagnostique">Performances et diagnostique</a>
                                </li>
                                                    </ul>
                                            <ul>
                                                            <li>
                                    <a href="/rix/services#conception_infrastructures">Conception sur-mesure d&#039;infrastructures</a>
                                </li>
                                                            <li>
                                    <a href="/rix/services#pilotage_infrastructures">Pilotage d&#039;infrastructures</a>
                                </li>
                                                            <li>
                                    <a href="/rix/services#environment">Environnement de d√©veloppement</a>
                                </li>
                                                    </ul>
                                    </div>
            </div>
        </nav>
        <div class="footer__legals">
            <span>¬©2024 - Rix - Tous droits r√©serv√©s</span>
            -
            <a href="/rix/legal">Mentions l√©gales</a>
            -
            <a href="/rix/confidentialite">Donn√©es personnelles</a>
        </div>
    </div>
</footer>



            </body>
</html>
