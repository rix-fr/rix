<!DOCTYPE html>
<html lang="fr" class="no-js">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Ansible - Roles et collections, savoir factoriser.</title>

        <!-- Favicon -->
        <link rel="apple-touch-icon" sizes="180x180" href="/rix/pr/138/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="96x96" href="/rix/pr/138/favicon-96x96.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/rix/pr/138/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/rix/pr/138/favicon-16x16.png">
        <link rel="manifest" href="/rix/pr/138/site.webmanifest">
                <link rel="shortcut icon" href="/rix/pr/138/favicon.ico">
        <meta name="msapplication-TileColor" content="#ff4344">
        <meta name="msapplication-config" content="/rix/pr/138/browserconfig.xml">
        <meta name="theme-color" content="#ffffff">

                        <meta name="description" content="Automatiser c&#039;est bien, faire en sorte que cela soit r√©utilisable simplement c&#039;est mieux. Mise en oeuvre des collections et roles avec Ansible." />
            <link rel="canonical" href="https://rix-fr.github.io/rix/pr/138/blog/cours/ansible/ansible-les-roles" />

            <!-- Open Graph / Facebook -->
                                        <meta property="og:type" content="website">
                        <meta property="og:title" content="Ansible - Roles et collections, savoir factoriser." />
            <meta property="og:locale" content="fr" />
            <meta property="og:description" content="Automatiser c&#039;est bien, faire en sorte que cela soit r√©utilisable simplement c&#039;est mieux. Mise en oeuvre des collections et roles avec Ansible." />
            <meta property="og:url" content="https://rix-fr.github.io/rix/pr/138/blog/cours/ansible/ansible-les-roles" />
            <meta property="og:site_name" content="rix" />

                                        <meta property="og:image" content="https://rix-fr.github.io/rix/pr/138/resized/content/images/blog/thumbnails/ansible-les-roles.jpg/78d8d30de26aff170a9ed5a8686e2f5e.jpg">
                                                    <meta property="og:image:alt" content="Rix - Expertise et outillage DevOps">
            
            <!-- Twitter -->
            <meta property="twitter:card" content="summary_large_image">
            <meta property="twitter:title" content="Ansible - Roles et collections, savoir factoriser.">
            <meta property="twitter:description" content="Automatiser c&#039;est bien, faire en sorte que cela soit r√©utilisable simplement c&#039;est mieux. Mise en oeuvre des collections et roles avec Ansible.">
            <meta property="twitter:site" content="@rix_fr">
            <meta property="twitter:creator" content="@rix_fr">
                                        <meta property="twitter:image" content="https://rix-fr.github.io/rix/pr/138/resized/content/images/blog/thumbnails/ansible-les-roles.jpg/f593d9e7bb0bc2fa23d8b8191a30b0df.jpg">
                                <script type="application/ld+json">{
    "@context": "https://schema.org",
    "@type": "NewsArticle",
    "headline": "Ansible - Roles et collections, savoir factoriser.",
    "image": [
        "https://rix-fr.github.io/rix/pr/138/blog/cours/ansible/content/images/blog/thumbnails/ansible-les-roles.jpg"
    ],
    "datePublished": "26 f√©vrier 2024",
    "dateModified": "26 f√©vrier 2024",
    "author": [
        {
            "@type": "Person",
            "name": "Guewen Faivre"
        }
    ],
    "keywords": [
        "Cours",
        "Ansible",
        "Automation",
        "Playbook",
        "Collection",
        "Role"
    ]
}
    </script>
            

    <link rel="alternate" type="application/rss+xml" href="/rix/pr/138/blog/rss.xml" title="Le blog de l'√©quipe Rix" />

                            <meta name="robots" content="noindex" />
        
        <script>
                        document.querySelector('html').classList.remove('no-js');
        </script>

                    <link rel="stylesheet" href="/rix/pr/138/build/305.47b05e40.css">
        
                    <script src="/rix/pr/138/build/runtime.0d6bdadd.js" defer></script><script src="/rix/pr/138/build/70.671fda9c.js" defer></script><script src="/rix/pr/138/build/app.e999eb99.js" defer></script>

                        <script defer src="https://comments.rix.fr/comentario.js"></script>
        
    </head>
    <body class="page-article">
                    <header class="header">
                <div class="container">
                    <a href="/rix/pr/138/">
                        <img src="/rix/pr/138/build/images/logos/logo-horizontal.ae7b8485.svg" alt="" class="logo">
                        <span class="screen-reader">Retour √† l'accueil</span>
                    </a>

                                            <nav class="nav">
    <ul>
                                    <li class="nav__item ">
                    <a href="/rix/pr/138/">
                        <span>Accueil</span>
                    </a>
                </li>
                                                <li class="nav__item ">
                    <a href="/rix/pr/138/services">
                        <span>Nos services</span>
                    </a>
                </li>
                                                <li class="nav__item ">
                    <a href="/rix/pr/138/etudes-de-cas">
                        <span>Cas clients</span>
                    </a>
                </li>
                                                <li class="nav__item ">
                    <a href="/rix/pr/138/a-propos">
                        <span>√Ä propos</span>
                    </a>
                </li>
                                                <li class="nav__item ">
                    <a href="/rix/pr/138/blog">
                        <span>Blog</span>
                    </a>
                </li>
                            <li class="nav__item nav__item--icon">
            <a href="/rix/pr/138/contact">
                <svg viewBox="0 0 20 17" fill="none" class="contact-icon">
    <path d="M18.7692 12.4368H16.343V15L12.3512 12.4368H1V1H18.7692V12.4368Z" stroke="#99b7d1" stroke-width="2" fill="none"/>
    <g>
        <circle cx="5.84621" cy="6.92311" r="1.07692" fill="#eb5050"/>
        <circle cx="10.1538" cy="6.92311" r="1.07692" fill="#eb5050"/>
        <circle cx="14.4614" cy="6.92311" r="1.07692" fill="#eb5050"/>
    </g>
</svg>

                <span>Contactez-nous</span>
            </a>
        </li>
    </ul>
</nav>

                    
                                            <nav class="nav-mobile">
    <div class="nav-mobile__header">
        <a href="/rix/pr/138/">
            <img src="/rix/pr/138/build/images/logos/logo-horizontal-white.901392b9.svg" alt="" class="logo">
        </a>
        <button class="nav-toggle nav-toggle--close">
            <i class="icon icon--close" aria-hidden="true"></i>
            <span class="screen-reader">Fermer le menu</span>
        </button>
    </div>
    <ul>
                                    <li class="nav-mobile__item  ">
                    <a href="/rix/pr/138/">
                        Accueil
                    </a>
                </li>
                                                <li class="nav-mobile__item  ">
                    <a href="/rix/pr/138/services">
                        Nos services
                    </a>
                </li>
                                                <li class="nav-mobile__item  ">
                    <a href="/rix/pr/138/etudes-de-cas">
                        Cas clients
                    </a>
                </li>
                                                <li class="nav-mobile__item  ">
                    <a href="/rix/pr/138/a-propos">
                        √Ä propos
                    </a>
                </li>
                                                <li class="nav-mobile__item  ">
                    <a href="/rix/pr/138/blog">
                        Blog
                    </a>
                </li>
                            <li class="nav-mobile__item nav-mobile__item--icon">
            <a href="/rix/pr/138/contact">
                <svg viewBox="0 0 20 17" fill="none" class="contact-icon">
    <path d="M18.7692 12.4368H16.343V15L12.3512 12.4368H1V1H18.7692V12.4368Z" stroke="#99b7d1" stroke-width="2" fill="none"/>
    <g>
        <circle cx="5.84621" cy="6.92311" r="1.07692" fill="#eb5050"/>
        <circle cx="10.1538" cy="6.92311" r="1.07692" fill="#eb5050"/>
        <circle cx="14.4614" cy="6.92311" r="1.07692" fill="#eb5050"/>
    </g>
</svg>

                Contactez-nous
            </a>
        </li>
    </ul>
</nav>
<button class="nav-toggle nav-toggle--open">
    <i class="icon icon--hamburger" aria-hidden="true"></i>
    <span class="screen-reader">Ouvrir le menu</span>
</button>

                                    </div>
            </header>
                <main>
                <div class="banner banner--blog">
        <div class="container">
            <h1>
                <a href="/rix/pr/138/blog">Blog</a>
                <strong>/</strong>
            </h1>
        </div>
    </div>

    <div class="beveled-wrapper">
        <div class="beveled-wrapper__gradient">
            <div class="container shape"><!-- üê∫ shape --></div>
            <div class="container content">
                <ul class="tags-list">
                                            <li class="tags-list__item">
                            #Cours
                        </li>
                                            <li class="tags-list__item">
                            #Ansible
                        </li>
                                            <li class="tags-list__item">
                            #Automation
                        </li>
                                            <li class="tags-list__item">
                            #Playbook
                        </li>
                                            <li class="tags-list__item">
                            #Collection
                        </li>
                                            <li class="tags-list__item">
                            #Role
                        </li>
                                    </ul>
                <h2 class="h2--large">Ansible - Roles et collections, savoir factoriser.</h2>
                <p>Automatiser c&#039;est bien, faire en sorte que cela soit r√©utilisable simplement c&#039;est mieux. Mise en oeuvre des collections et roles avec Ansible.</p>
                <div class="article-overview">
                                        <ol class="table-of-contents">
                                                            <li class="table-of-contents__item">
                                    <a href="#preambule">Pr√©ambule</a>
                                                                    </li>
                                                            <li class="table-of-contents__item">
                                    <a href="#pre-requis">Pr√©-requis</a>
                                                                    </li>
                                                            <li class="table-of-contents__item">
                                    <a href="#introduction">Introduction</a>
                                                                    </li>
                                                            <li class="table-of-contents__item">
                                    <a href="#les-roles">Les r√¥les</a>
                                                                            <ol class="table-of-contents__sub-level">
                                                                                            <li>
                                                    <a href="#creer-son-premier-role">Cr√©er son premier r√¥le</a>
                                                </li>
                                                                                            <li>
                                                    <a href="#organisation-et-structures-de-controle-avancees">Organisation et structures de contr√¥le avanc√©es</a>
                                                </li>
                                                                                            <li>
                                                    <a href="#declarer-les-variables-de-roles">D√©clarer les variables de r√¥les</a>
                                                </li>
                                                                                    </ol>
                                                                    </li>
                                                            <li class="table-of-contents__item">
                                    <a href="#point-de-progression">Point de progression</a>
                                                                    </li>
                                                            <li class="table-of-contents__item">
                                    <a href="#aller-plus-loin-avec-les-sources">Aller plus loin avec les sources</a>
                                                                    </li>
                                                    </ol>
                                        <div class="article-info">
                                                                            <div class="author ">
                                <div class="author__image">
                                                                            <img     src="/rix/pr/138/resized/content/images/member/avatars/gfaivre.jpg/b9e2ad5ccb2390253e2c23ccbfb41dc7.jpg"
    srcset="
        /rix/pr/138/resized/content/images/member/avatars/gfaivre.jpg/b9e2ad5ccb2390253e2c23ccbfb41dc7.jpg 1x,
        /rix/pr/138/resized/content/images/member/avatars/gfaivre.jpg/d2d8af0b210c37c677635983f1c02d6d.jpg 2x
    "
 />
                                                                    </div>
                                <span class="author__info">
                                    √âcrit par
                                                                            <strong>Guewen Faivre</strong>
                                                                    </span>
                            </div>
                                                <div class="article-info__date">
                            <span>Publication <strong>26 f√©vrier 2024</strong></span>
                                                                                </div>
                    </div>
                </div>
                <main>
                                                            <body><h2 id="preambule" class="anchor-title"><a href="#preambule">Pr√©ambule</a></h2>
<p>Ce cours est utilis√© dans le cadre de TP au sein de l'IUT Lyon 1. Il est notamment dispens√© √† des √©tudiants peu ou pas familiers avec les strat√©gies d'automatisation et de d√©ploiement des infrastructures.
Bien que tr√®s ax√© d√©butants il peut √©galement repr√©sent√© une possibilit√© de monter ¬´ rapidement ¬ª pour certaines √©quipes sur les principes fondamentaux d'Ansible afin de disposer du bagage minimal n√©cessaire √† son utilisation.</p>
<p>Il s'agit bien √©videmment de supports √† vocation p√©dagogique qui <strong>ne sont pas toujours transposables</strong> √† une activit√© professionnelle.</p>
<h2 id="pre-requis" class="anchor-title"><a href="#pre-requis">Pr√©-requis</a></h2>
<p>Avoir suivi/lu les cours concernant: </p>
<ul>
<li>les <a href="/blog/cours/ansible/ansible-les-inventaires-statiques">inventaires</a>;</li>
<li>les <a href="/blog/cours/ansible/ansible-les-playbooks">playbooks</a>;</li>
<li>les <a href="/blog/cours/ansible/ansible-les-variables">variables</a>.</li>
</ul>
<h2 id="introduction" class="anchor-title"><a href="#introduction">Introduction</a></h2>
<p>Pr√©c√©demment nous avons vu l'utilisation des concepts fondamentaux d'Ansible, toutefois au fur et √† mesure de l'√©volution de ce TD vous avez du vous poser plusieurs questions et notamment celles de la <strong>maintenance et de la r√©utilisation</strong> de tout ce qu'on √† fait.
Et vous avez bien raison, car jusqu'√† pr√©sent nous n'avons rien produit de bien r√©utilisable et de correctement maintenable.</p>
<p>En effet nos playbooks contiennent de nombreuses instructions qui bien que li√©es n'ont pas forc√©ment pour finalit√© de cohabiter et l'ensemble de ces instructions paraissent en l'√©tat, bien difficilement transposables √† d'autres projets/contextes.</p>
<p>Il est donc plus que temps d'int√©grer le concept de <strong>r√¥le</strong> et plus largement de <strong>collection</strong>.</p>
<h2 id="les-roles" class="anchor-title"><a href="#les-roles">Les r√¥les</a></h2>
<p>Au sens Ansible un r√¥le est assimilable √† un <strong>regroupement de t√¢ches</strong> qui (normalement) s'orientent vers un m√™me objectif. ¬´ Normalement ¬ª car encore une fois c'est vous qui √™tes ma√Ætre de ce que vous embarquer dans un r√¥le mais d'exp√©rience je ne saurai que vous conseiller de bien d√©finir le p√©rim√®tre d'application de chacun de vos r√¥les et de vous y tenir ;) ! </p>
<p>On peut ainsi s'imaginer un r√¥le d√©di√© √† la gestion de notre serveur web nginx ou encore √† un serveur de bases de donn√©es PostgreSQL.</p>
<p>La structure d'un r√¥le est tr√®s similaire √† l'organisation que l'on a pu voir jusqu'√† pr√©sent, on retrouvera ainsi une arborescence type:</p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="db6efd5f9971ad93ff86fc3ce7a89265">roles/
    nginx/                <span class="token comment"># this hierarchy represents a "role"</span>
        tasks/            <span class="token comment">#</span>
            main.yml      <span class="token comment">#  &lt;-- tasks file can include smaller files if warranted</span>
        handlers/         <span class="token comment">#</span>
            main.yml      <span class="token comment">#  &lt;-- handlers file</span>
        templates/        <span class="token comment">#  &lt;-- files for use with the template resource</span>
            app.conf.j2   <span class="token comment">#  &lt;------- templates end in .j2</span>
        files/            <span class="token comment">#</span>
            bar.conf      <span class="token comment">#  &lt;-- files for use with the copy resource</span>
            foo.sh        <span class="token comment">#  &lt;-- script files for use with the script resource</span>
        vars/             <span class="token comment">#</span>
            main.yml      <span class="token comment">#  &lt;-- variables associated with this role</span>
        defaults/         <span class="token comment">#</span>
            main.yml      <span class="token comment">#  &lt;-- default lower priority variables for this role</span>
        meta/             <span class="token comment">#</span>
            main.yml      <span class="token comment">#  &lt;-- role dependencies</span>
        library/          <span class="token comment"># roles can also include custom modules</span>
        module_utils/     <span class="token comment"># roles can also include custom module_utils</span>
        lookup_plugins/   <span class="token comment"># or other types of plugins, like lookup in this case</span></code></pre>
<p>Ansible pr√©voit un r√©pertoire d√©di√© aux r√¥les dans lequel nous retrouverons <strong>un r√©pertoire par r√¥le</strong>, chacun de ces r√¥les ob√©issant √† la structure d√©finie ci-dessus.</p>
<div class="admonition info">
<p class="admonition-title">Structure d'un r√¥le</p>
<p>
    Un r√¥le doit contenir <strong>au moins</strong> un des r√©pertoires de l'arborescence ci-dessus. √Ä l'inverse si certains r√©pertoires ne sont pas n√©cessaires √† son fonctionnement, ils peuvent √™tre omis.
    Par d√©faut Ansible ¬´ recherchera ¬ª les instructions d'un r√©pertoire dans un fichier <code class="code-inline" id="c0c84c46776cbacdea8e3ecb98f3dd65">main.yml</code>.
</p>
</div>
<p>Ansible par d√©faut ¬´ recherchera ¬ª des r√¥les √† diff√©rents endroits:</p>
<ul>
<li>Dans l'emplacement destin√© aux <strong>collections</strong> (dont nous parlerons juste apr√®s);</li>
<li>Dans un r√©pertoire <code class="code-inline" id="4295e8065f2f640103f566df3329e17f">roles</code> relativement √† la position de notre fichier de playbook;</li>
<li>√Ä partir de la cl√© <code class="code-inline" id="6a6caaf55798ec748f53398dd5ab0d0e">role_path</code> configurable notamment dans le fichier de configuration <code class="code-inline" id="0485be50e14d7e6644f184d2d75f7d3c">ansible.cfg</code>;</li>
<li>Et pour finir dans le r√©pertoire ou se trouve le playbook.</li>
</ul>
<p>Il est possible de faire cohabiter tout ce beau monde et d'avoir par exemple des r√¥les communautaires tout en ayant des r√¥les propres √† votre projet / soci√©t√© mais qui n'ont pas forc√©ment vocation √† √™tre partag√©s !</p>
<h3 id="creer-son-premier-role" class="anchor-title"><a href="#creer-son-premier-role">Cr√©er son premier r√¥le</a></h3>
<p>Reprenons nos travaux pr√©c√©dent. Nous avions au final plusieurs t√¢ches, chacune charg√©e de faire des choses bien diff√©rentes (Nginx, PHP, motd...)
Notre objectif pour cette fois sera de <strong>refactoriser ces sections</strong> de mani√®re √† les transformer en <strong>r√¥les</strong>.</p>
<h4 id="un-role-motd" class="anchor-title"><a href="#un-role-motd">Un r√¥le Motd</a></h4>
<p>Rien de bien compliqu√© pour commencer, histoire de ne pas vous perdre tout de suite ;)
Cr√©ons notre arborescence dans un r√©pertoire <code class="code-inline" id="4295e8065f2f640103f566df3329e17f">roles</code> <strong>√† la racine de notre r√©pertoire de travail</strong> en y ajoutant un r√©pertoire <code class="code-inline" id="8776dc2b7228908a1ba75b6547efede7">motd</code>.
Dans ce dernier nous allons ensuite cr√©er les r√©pertoires <code class="code-inline" id="2cb1ad4f3eb0ea704c74a73689ad1654">tasks</code> et <code class="code-inline" id="a4a918a45181164207929d52aec36aec">defaults</code>.</p>
<p>√Ä l'int√©rieur de chacun de ces r√©pertoires nouvellement cr√©√©s nous ajouterons un fichier <code class="code-inline" id="c0c84c46776cbacdea8e3ecb98f3dd65">main.yml</code>, pour l'instant vide.</p>
<p>Nous cr√©erons √©galement une arborescence <code class="code-inline" id="b35c9eb4b3769e2d7572c34c9da4ba19">templates/scripts</code> dans notre role et nous y ¬´ rapatrierons ¬ª nos fichiers de template <code class="code-inline" id="1eeadef35e0afa776e8733abce2e8598">production.j2</code> et <code class="code-inline" id="ea44399be7b5e71b5d499f43a541e397">staging.j2</code> du r√©pertoire <code class="code-inline" id="fed36e93a0509e20f2dc96cbbd85b678">templates</code> √† la racine de notre projet vers le r√©pertoire <code class="code-inline" id="b35c9eb4b3769e2d7572c34c9da4ba19">templates/scripts</code> de notre r√¥le.</p>
<p>Vous devriez √† ce stade disposer d'une arborescence pour le r√¥le <strong>motd</strong> similaire √† la suivante:</p>
<pre class="code-multiline language-shell"><code class="language-shell" id="8b48f80264c17dfafe42fe6816cc41b9">motd
‚îú‚îÄ‚îÄ defaults
‚îÇ   ‚îî‚îÄ‚îÄ main.yml
‚îú‚îÄ‚îÄ tasks
‚îÇ   ‚îú‚îÄ‚îÄ main.yml
‚îÇ   ‚îî‚îÄ‚îÄ scripts.yml
‚îî‚îÄ‚îÄ templates
    ‚îî‚îÄ‚îÄ scripts
        ‚îú‚îÄ‚îÄ production.j2
        ‚îî‚îÄ‚îÄ staging.j2</code></pre>
<p>√Ä pr√©sent nous allons ¬´ redescendre ¬ª la t√¢che motd de notre playbook <code class="code-inline" id="35e10f4319de8bbbbd2033b3448a5e5d">webservers.yml</code> vers le fichier <code class="code-inline" id="2444ad0870f91f17ca6c2a5e96b26823">tasks/main.yml</code> de notre r√¥le.</p>
<p>Il nous faudra adapter notre t√¢che √† notre nouvelle arborescence:</p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="5a357d7f1d1a59bb5b1d7114329aefc8"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MOTD <span class="token punctuation">&gt;</span> Installing template
  <span class="token key atrule">ansible.builtin.template</span><span class="token punctuation">:</span>
    <span class="token key atrule">src</span><span class="token punctuation">:</span> <span class="token string">"scripts/{{stage}}.j2"</span>
    <span class="token key atrule">dest</span><span class="token punctuation">:</span> <span class="token string">"/etc/update-motd.d/10-welcome"</span>
    <span class="token key atrule">owner</span><span class="token punctuation">:</span> root
    <span class="token key atrule">group</span><span class="token punctuation">:</span> root
    <span class="token key atrule">mode</span><span class="token punctuation">:</span> <span class="token string">"0755"</span></code></pre>
<p>√Ä ce stade vous avez un premier r√¥le tr√®s simple et fonctionnel, il nous reste √† assurer son d√©clenchement au niveau de notre playbook <code class="code-inline" id="35e10f4319de8bbbbd2033b3448a5e5d">webservers.yml</code> que nous allons modifier de mani√®re √† int√©grer l'ex√©cution de notre r√¥le:</p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="f4ff126908acf7303a79b2254a233053"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"Configuring webservers"</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> webservers

  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> motd

  <span class="token key atrule">pre_tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"Common tasks"</span>
    <span class="token punctuation">...</span></code></pre>
<p>En ex√©cutant la commande <code class="code-inline" id="ff2336ad0e6cf0fd72a2c936a67fe361">ansible-playbook -i inventories main.yml</code> vous ne devriez constater aucun changements notables si ce n'est que l'ex√©cution des instructions relatives √† la configuration de motd se fait d√©sormais √† partir de notre nouveau r√¥le.</p>
<h3 id="organisation-et-structures-de-controle-avancees" class="anchor-title"><a href="#organisation-et-structures-de-controle-avancees">Organisation et structures de contr√¥le avanc√©es</a></h3>
<p>Dans le but d'√©toffer et de rendre <strong>un peu plus robuste</strong> notre r√¥le nous allons introduire quelques contraintes:</p>
<ul>
<li>La possibilit√© d'activer ou non une fonctionnalit√© de contr√¥le des motd existants c√¥t√© serveur (tol√®re t-on ou non la pr√©sence de motd non g√©r√©s par notre r√¥le ?);</li>
<li>La possibilit√© de choisir le r√©pertoire d'installation de nos scripts motd;</li>
<li>La possibilit√© d'avoir plusieurs scripts d√©ploy√©s (actuellement nous n'en d√©ployons qu'un seul).</li>
</ul>
<p>Mais avant de commencer nous allons, pour l'exemple voir que nous pouvons tout √† fait (et c'est d'ailleurs tr√®s courant) g√©r√© l'inclusion de t√¢ches dans nos r√¥les comme dans nos playbook principaux.</p>
<p>Cr√©ons dans le r√©pertoire <code class="code-inline" id="563d664f9447abba6124ea1b6aade3d4">roles/motd/tasks</code> un fichier nomm√© <code class="code-inline" id="aafc68c07cc65c24b090ad13e2c1d05d">scripts.yml</code> dans lequel nous allons transf√©rer le contenu du fichier <code class="code-inline" id="2ee2cbf5f3784c716c408d5f38dad23a">roles/motd/tasks/main.yml</code>.</p>
<p>√Ä pr√©sent dans notre fichier <code class="code-inline" id="2ee2cbf5f3784c716c408d5f38dad23a">roles/motd/tasks/main.yml</code> nous ajoutons les instructions suivantes:</p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="ccb92a7404eccc93a33af4510e07ee97"><span class="token punctuation">---</span>

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Scripts
  <span class="token key atrule">ansible.builtin.import_tasks</span><span class="token punctuation">:</span> scripts.yml
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> workshop_motd
    <span class="token punctuation">-</span> workshop_motd.scripts</code></pre>
<p>On y retrouve les instructions d'import de t√¢ches mais √©galement les <strong>tags sp√©cifiques</strong> qui nous permettrons de <a href="/blog/cours/ansible/ansible-les-playbooks#taguer-ses-taches">cibler nos ex√©cutions</a>.</p>
<h3 id="declarer-les-variables-de-roles" class="anchor-title"><a href="#declarer-les-variables-de-roles">D√©clarer les variables de r√¥les</a></h3>
<p>Souvenez-vous, nous avons cr√©√© un r√©pertoire <code class="code-inline" id="a4a918a45181164207929d52aec36aec">defaults</code>, celui-ci va contenir les variables utilis√©es par notre r√¥le et leur valeur par d√©faut.</p>
<h4 id="initialisation-de-variables-par-defaut" class="anchor-title"><a href="#initialisation-de-variables-par-defaut">Initialisation de variables par ¬´ d√©faut ¬ª</a></h4>
<p>Une bonne pratique consiste √† toujours d√©clarer les variables qui seront utilis√©es dans notre r√¥le.
Dans notre cas nous utiliserons 3 variables que nous allons donc d√©clarer dans le fichier <code class="code-inline" id="1f4b4c39205109d4cfa93f1513d9a22d">roles/motd/defaults/main.yml</code>.</p>
<p>Dans le fichier <code class="code-inline" id="7eeda618087b49ae876084ab6c73fdbb">defaults/main.yml</code> nous ajouterons donc:</p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="59c33ff2281ce685ffec433bd38f39ce"><span class="token punctuation">---</span>

<span class="token key atrule">workshop_motd_scripts_exclusive</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">workshop_motd_scripts_dir</span><span class="token punctuation">:</span> /etc/update<span class="token punctuation">-</span>motd.d
<span class="token key atrule">workshop_motd_scripts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></code></pre>
<p><strong>Dans l'ordre:</strong></p>
<ul>
<li>Une variable qui nous servira √† <strong>configurer l'exclusivit√©</strong> des scripts motd;</li>
<li>Une seconde qui permettra de configurer le r√©pertoire cible de destination de nos scripts;</li>
<li>Et enfin une derni√®re qui nous permettra de param√©trer les scripts √† d√©ployer c√¥t√© serveur.</li>
</ul>
<h4 id="exclusivite" class="anchor-title"><a href="#exclusivite">Exclusivit√©</a></h4>
<p>Premi√®re contrainte, faire en sorte que notre r√¥le <strong>soit la r√©f√©rence</strong> en terme d'√©tat de la machine cible.
Pour se faire, l'id√©e et de ne conserver √† l'ex√©cution que les scripts <strong>d√©clar√©s</strong> dans notre configuration.</p>
<p>Avant de nous lancer, il va falloir faire √©voluer l√©g√®rement notre variable <code class="code-inline" id="ee36da712d28543c21cf09f2396e8a6b">workshop_motd_scripts</code> que vous retrouverez dans les fichiers:</p>
<ul>
<li><code class="code-inline" id="c3cc6827c1824b0a57b298489ce26597">group_vars/production.yml</code> que nous modifierons comme ci-dessous:</li>
</ul>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="84e042358367ff6ea7fd529f17950ca6"><span class="token key atrule">workshop_motd_scripts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">file</span><span class="token punctuation">:</span> 10<span class="token punctuation">-</span>message
    <span class="token key atrule">template</span><span class="token punctuation">:</span> scripts/<span class="token punctuation">{</span><span class="token punctuation">{</span> stage <span class="token punctuation">}</span><span class="token punctuation">}</span>.j2
    <span class="token key atrule">message</span><span class="token punctuation">:</span> Attention environnement de production <span class="token tag">!</span>
  <span class="token punctuation">-</span> <span class="token key atrule">file</span><span class="token punctuation">:</span> 20<span class="token punctuation">-</span>uname</code></pre>
<ul>
<li><code class="code-inline" id="337425bdec603d6a2d4f366b58781ac6">group_vars/staging.yml</code> que nous modifierons comme ci-dessous:</li>
</ul>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="ae13d93f1510982ac6ec481e268c9d5c"><span class="token key atrule">workshop_motd_scripts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">file</span><span class="token punctuation">:</span> 10<span class="token punctuation">-</span>message
    <span class="token key atrule">template</span><span class="token punctuation">:</span> scripts/<span class="token punctuation">{</span><span class="token punctuation">{</span> stage <span class="token punctuation">}</span><span class="token punctuation">}</span>.j2
    <span class="token key atrule">message</span><span class="token punctuation">:</span> Environnement de staging <span class="token tag">!</span></code></pre>
<p>Nous avons fait √©voluer la structure de notre variable vers une structure plus complexe:</p>
<ul>
<li><code class="code-inline" id="8c7dd922ad47494fc02c388e12c00eac">file</code>: contient le nom du fichier attendu c√¥t√© machine cible;</li>
<li><code class="code-inline" id="66f6181bcb4cff4cd38fbc804a036db6">template</code>: indique le fichier de template √† utiliser;</li>
<li><code class="code-inline" id="78e731027d8fd50ed642340b7c9a63b3">message</code>: contient le message √† afficher dans notre motd.</li>
</ul>
<p>Nous avons donc d√©fini <strong>deux scripts motd</strong> √† installer sur notre environnement de production et <strong>un seul</strong> sur notre environnement de staging.</p>
<div class="admonition info">
<p class="admonition-title">L'option register</p>
<p>
    L'utilisation de l'option <code class="code-inline" id="9de4a97425678c5b1288aa70c1669a64">register</code> permet de cr√©er une variable √† partir des donn√©es de sortie r√©sultantes de l'ex√©cution d'une t√¢che, dans le but de r√©utiliser cette variable <strong>dans une autre t√¢che √† venir</strong>.
</p>
</div>
<p>Nous pouvons donc √† pr√©sent positionner en tout d√©but du fichier <code class="code-inline" id="48185f0fcc44358d6888a71d4fa7b64d">roles/motd/tasks/scripts.yaml</code> le bloc d'instruction suivant:</p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="e14b0c4e210d2c180e07d1d94cc11f85"><span class="token punctuation">---</span>

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Checking files to exclude
  <span class="token key atrule">ansible.builtin.set_fact</span><span class="token punctuation">:</span>
    <span class="token key atrule">workshop_scripts_list</span><span class="token punctuation">:</span> <span class="token string">"{{ workshop_scripts_list|default([]) + [item.file] }}"</span>
  <span class="token key atrule">changed_when</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">loop</span><span class="token punctuation">:</span> <span class="token string">"{{ workshop_motd_scripts }}"</span>

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MOTD <span class="token punctuation">&gt;</span> Exclusive
  <span class="token key atrule">ansible.builtin.find</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">"{{ workshop_motd_scripts_dir }}"</span>
    <span class="token key atrule">file_type</span><span class="token punctuation">:</span> file
    <span class="token key atrule">patterns</span><span class="token punctuation">:</span> <span class="token string">"*"</span>
    <span class="token key atrule">excludes</span><span class="token punctuation">:</span> <span class="token string">"{{ workshop_scripts_list }}"</span>
  <span class="token key atrule">changed_when</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">register</span><span class="token punctuation">:</span> __workshop_motd_scripts_exclusive_find
  <span class="token key atrule">when</span><span class="token punctuation">:</span> workshop_motd_scripts_exclusive</code></pre>
<p>Le premier bloc d'instruction aura vocation √† lister sous forme d'un tableau ¬´ plat ¬ª la liste des scripts que nous avons d√©cid√© d'avoir sur notre serveur (variable <code class="code-inline" id="ee36da712d28543c21cf09f2396e8a6b">workshop_motd_scripts</code>).
Le but √©tant de r√©cup√©rer une variable contenant des informations compr√©hensibles par l'option <code class="code-inline" id="7d1b98ec98cdcfba1cb39cb36a9f9ec0">excludes</code> du module <code class="code-inline" id="e7360693cd4330280f258bc143ead2d9">ansible.builtin.find</code> dont le comportement est similaire √† la commande UNIX.</p>
<p>La seconde t√¢che aura pour but de lister les fichiers c√¥t√© serveur correspondant aux options que l'on aura pass√©es au module √† savoir:</p>
<ul>
<li>N'importe quel fichier de type fichier (Il n'y a pas de redondance ici, n'oubliez pas que dans un syst√®me UNIX, TOUT est fichier)</li>
<li>Dont le nom remplit les conditions du param√®tre <code class="code-inline" id="240bf022e685b0ee30ad9fe9e1fb5d5b">pattern</code> √† savoir ¬´ * ¬ª soit n'importe quel caract√®re ou pour r√©sumer tous les fichiers ;);</li>
<li>En excluant les fichiers pr√©sents dans la variable <code class="code-inline" id="a134baf0cf59d3fe5ac1d51d131a3c07">workshop_scripts_list</code>.</li>
</ul>
<div class="admonition info">
<p class="admonition-title">L'instruction loop</p>
<p>
    L'instruction ¬´ loop ¬ª permet d'adopter un comportement it√©ratif au niveau de nos t√¢ches. Ainsi la variable consid√©r√©e en param√®tre de l'instruction sera it√©r√©e dans la t√¢che concern√©e. Chaque it√©ration rendant accessible les √©l√©ments via la variable ¬´ item ¬ª.
</p>
</div>
<p><strong>Les points √† retenir:</strong></p>
<ul>
<li>La t√¢che charg√©e de lister les scripts pr√©vus dans nos fichiers de ¬´ provisionning ¬ª;</li>
<li>L'utilisation du module <code class="code-inline" id="8c7dd922ad47494fc02c388e12c00eac">file</code> et de ses param√®tres qui nous permet de r√©cup√©rer tous les √©l√©ments (*) de type fichier du r√©pertoire cible;</li>
<li>L'utilisation de notre variable de r√¥le <code class="code-inline" id="8e0442e53cb0e3972df373192cfec350">workshop_motd_scripts_dir</code>;</li>
<li>Le conditionnement de l'ex√©cution avec l'instruction <code class="code-inline" id="df491a4de50739fa9cffdbd4e3f4b4bb">when</code> en fonction de la valeur de la variable <code class="code-inline" id="a44882030bf60cf6177ac274e10a07b2">workshop_motd_scripts_exclusive</code>.</li>
</ul>
<div class="admonition info">
<p class="admonition-title">L'option changed_when</p>
<p>
    L'option <code class="code-inline" id="0675d5ed9920bb041681c1d5489709e6">changed_when</code> nous permet de ¬´ d√©cider ¬ª si une t√¢che a modifi√© (au sens Ansible) notre machine cible. En fonction de son retour nous pouvons donc d√©cider si un changement doit √™tre mentionn√© ou si un <code class="code-inline" id="c1cbfe271a40788a00e8bf8574d94d4b">handler</code> doit √™tre d√©clench√©. Bon √† savoir √©galement, si vous y d√©finissez plusieurs conditions celles-ci sont jointes avec un op√©rateur <code class="code-inline" id="be5d5d37542d75f93a87094459f76678">and</code> par d√©faut.
</p>
</div>
<p>Nous avons donc r√©cup√©r√© la liste des fichiers pr√©sents sur notre machine cible il nous reste √† pr√©sent √† supprimer ceux qui ne sont pas g√©r√©s par notre script.</p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="afe4dbecd389d9091a4230f428a001f4"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Remove file (delete file)
  <span class="token key atrule">ansible.builtin.file</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">"{{ item.path }}"</span>
    <span class="token key atrule">state</span><span class="token punctuation">:</span> absent
  <span class="token key atrule">loop</span><span class="token punctuation">:</span> <span class="token string">"{{ __workshop_motd_scripts_exclusive_find.files }}"</span></code></pre>
<p>On retrouve √† cette occasion l'utilisation du mot cl√© ¬´<strong>loop</strong>¬ª afin d'it√©rer sur la liste des fichiers √† supprimer.</p>
<h2 id="point-de-progression" class="anchor-title"><a href="#point-de-progression">Point de progression</a></h2>
<p>Nous avons √† travers cette s√©rie d'articles, fait le tour des principes fondamentaux d'Ansible. Ceci n'est bien √©videmment que le d√©but du chemin vers la ma√Ætrise d'Ansible mais c'est une premi√®re √©tape fondamentale avant d'aller plus loin ! </p>
<h2 id="aller-plus-loin-avec-les-sources" class="anchor-title"><a href="#aller-plus-loin-avec-les-sources">Aller plus loin avec les sources</a></h2>
<ul>
<li><a href="https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_reuse_roles.html" target="_blank">https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_reuse_roles.html</a></li>
<li><a href="https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_reuse_roles.html#embedding-modules-and-plugins-in-roles" target="_blank">https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_reuse_roles.html#embedding-modules-and-plugins-in-roles</a></li>
<li><a href="https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_error_handling.html#defining-changed" target="_blank">https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_error_handling.html#defining-changed</a></li>
<li><a href="https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_variables.html#registering-variables" target="_blank">https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_variables.html#registering-variables</a>
<a href="https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_loops.html" target="_blank">https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_loops.html</a></li>
</ul></body>
                                                                                </main>
                <div class="article-footer" data-aos="fade-in">
                                                                        <div class="author">
                                <div class="author__image">
                                    <img     src="/rix/pr/138/resized/content/images/member/avatars/gfaivre.jpg/b9e2ad5ccb2390253e2c23ccbfb41dc7.jpg"
    srcset="
        /rix/pr/138/resized/content/images/member/avatars/gfaivre.jpg/b9e2ad5ccb2390253e2c23ccbfb41dc7.jpg 1x,
        /rix/pr/138/resized/content/images/member/avatars/gfaivre.jpg/d2d8af0b210c37c677635983f1c02d6d.jpg 2x
    "
 />
                                </div>
                                <span class="author__info">
                                    √âcrit par
                                    <strong>Guewen Faivre</strong>
                                </span>
                                <div class="author__social">
                                                                            <a href="https://twitter.com/guewen_faivre">
                                            <i class="icon icon--twitter" aria-hidden="true"></i>
                                            <span class="screen-reader">Compte twitter de Guewen Faivre</span>
                                        </a>
                                                                                                                <a href="https://github.com/gfaivre">
                                            <i class="icon icon--github" aria-hidden="true"></i>
                                            <span class="screen-reader">Compte github de Guewen Faivre</span>
                                        </a>
                                                                                                                <a href="http://www.elao.com">
                                            <i class="icon icon--website" aria-hidden="true"></i>
                                            <span class="screen-reader">Site personnel de Guewen Faivre</span>
                                        </a>
                                                                    </div>
                            </div>
                                                            </div>
                                    <div class="comment">
                                                    <div id="comentario"></div>
                                                                                                    <p>
                                Une typo ?
                                <a href="https://github.com/rix-fr/rix/edit/update_sts_file/content/blog/cours/ansible/ansible-les-roles.md/" target="_blank">Modifier cet article sur Github</a>
                            </p>
                                            </div>
                            </div>
        </div>
    </div>
        </main>
                    <footer class="footer">
    <div class="container">
        <div class="footer__contact">
            <div class="catchphrase">
                <p class="h1">Le monde du DevOps vous semble obscur ?</p>
                <p>Contactez-nous, nous vous aiderons √† y <strong>voir plus clair</strong>.</p>
            </div>
            <div class="contact-tiles">
                <span class="contact-tiles__item">
                    <i class="icon icon--location" aria-hidden="true"></i>
                    <span>
                        <span class="title">Passez nous voir !</span>
                        <span>Nous sommes √† Lyon !</span>
                        <span>34 rue Jean Broquin</span>
                        <span>69006 Lyon, France</span>
                    </span>
                </span>
                <span class="contact-tiles__item">
                    <i class="icon icon--message" aria-hidden="true"></i>
                    <span>
                        <span class="title">Par t√©l√©phone ou par mail</span>
                        <a href="tel:33482537609">04 82 53 76 09</a>
                        <a href="mailto:contact@rix.fr">contact@rix.fr</a>
                    </span>
                </span>
            </div>
        </div>
        <div class="footer__brand">
            <img src="/rix/pr/138/build/images/logos/logo-horizontal-white.901392b9.svg" alt="Rix">
            <span>Expertise et outilllage DevOps</span>
        </div>
        <nav class="footer__links">
            <div class="pages">
                <ul>
                                                                        <li>
                                <a href="/rix/pr/138/etudes-de-cas">Cas clients</a>
                            </li>
                                                                                                <li>
                                <a href="/rix/pr/138/a-propos">√Ä propos</a>
                            </li>
                                                                                                <li>
                                <a href="/rix/pr/138/contact">Contact</a>
                            </li>
                                                            </ul>
            </div>
            <div class="services">
                <a href="/rix/pr/138/services">Nos services</a>
                <div>
                                            <ul>
                                                            <li>
                                    <a href="/rix/pr/138/services#accompagnement_outillage">Accompagnement et outillage DevOps</a>
                                </li>
                                                            <li>
                                    <a href="/rix/pr/138/services#experts_kubernetes">Expertise Kubernetes</a>
                                </li>
                                                            <li>
                                    <a href="/rix/pr/138/services#performances_diagnostique">Performances et diagnostique</a>
                                </li>
                                                    </ul>
                                            <ul>
                                                            <li>
                                    <a href="/rix/pr/138/services#conception_infrastructures">Conception sur-mesure d&#039;infrastructures</a>
                                </li>
                                                            <li>
                                    <a href="/rix/pr/138/services#pilotage_infrastructures">Pilotage d&#039;infrastructures</a>
                                </li>
                                                            <li>
                                    <a href="/rix/pr/138/services#environment">Environnement de d√©veloppement</a>
                                </li>
                                                    </ul>
                                    </div>
            </div>
        </nav>
        <div class="footer__legals">
            <span>¬©2025 - Rix - Tous droits r√©serv√©s</span>
            -
            <a href="/rix/pr/138/legal">Mentions l√©gales</a>
            -
            <a href="/rix/pr/138/confidentialite">Donn√©es personnelles</a>
        </div>
    </div>
</footer>



            </body>
</html>
